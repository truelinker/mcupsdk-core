<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: ADS131 Implementation Details</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM64x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">10.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLES_PRU_ADC_ADS131_DETAILS.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ADS131 Implementation Details </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_examples_pru_io_ads131_details"></a> </p>
<h1><a class="anchor" id="autotoc_md1560"></a>
Implementation Details</h1>
<p>The control of ADC pins is divided between PRU and R5F cores.</p>
<p>In example, the interfacing with ADS131M08 operates in following configuration:</p><ul>
<li>8 simultaneously sampling differential inputs</li>
<li>Programmable data rate up to 32 kSPS</li>
<li>Continous sampling of data</li>
<li>Signal trace for the current implementation is shown in figure below (can check timing details from this)</li>
</ul>
<p> <style>div.image img[src="ads131_timing_capture.png"]{width:50% height:120%}</style> </p><div class="image">
<img src="ads131_timing_capture.png" alt=""/>
</div>
<p>  <style>div.image img[src="ads131_timing_capture_1.png"]{width:50% height:120%}</style> </p><div class="image">
<img src="ads131_timing_capture_1.png" alt=""/>
</div>
<h3><a class="anchor" id="autotoc_md1561"></a>
R5F Function:</h3>
<ul>
<li>Write PRU firmware instructions into IRAM of PRU</li>
<li>Configure the IO Expander to connect the PRU IOs to HSE</li>
<li>Send ADC register configuration information to the PRU core</li>
<li>Send instructions to PRU core</li>
<li>Wait for interrupt from PRU indicating 1 block of adc samples has been received</li>
<li>On interrupt fetch the block id to read and read the samples</li>
<li>Process them as needed</li>
</ul>
<div class="fragment"><div class="line">/*  Total number of Commands to send to ADC */</div>
<div class="line">uint32_t noOfCommands = 2;</div>
<div class="line">/*  Commands array</div>
<div class="line"> *  Add your commands to this (maximum = noOfCommands)</div>
<div class="line"> */</div>
<div class="line">uint32_t adcConfigCommands[2] = {0x00618400,0x00FF0200};</div>
<div class="line"> </div>
<div class="line">ADC_init();</div>
<div class="line">ADC_powerUp();</div>
<div class="line">ADC_configure(noOfCommands, adcConfigCommands);</div>
<div class="line">ADC_startConversion();</div>
<div class="line"> </div>
<div class="line">/* Get ADC data from PRU */</div>
<div class="line">PRU_IPC_getData(gPruIpc0Handle, samples);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md1562"></a>
PRU Function:</h3>
<ul>
<li>Wait for commands from R5F and do accordingly While executing ADC interface section:</li>
<li>Wait for ADC Busy to go low indicating conversion has completed</li>
<li>Start reading samples from each ADC channel</li>
<li>Preprocess samples as required</li>
<li>Send samples to shared memory using ipc</li>
<li>Repeat above steps again</li>
</ul>
<div class="fragment"><div class="line">START:</div>
<div class="line">    ; Wait for DRDY to go low indicating conversion has completed</div>
<div class="line">    ; DRDY: _á †á †á †á †_____________________________________________________</div>
<div class="line">    ; SDI:  _____|  Status  |  &lt; Channel 0 - 7 Data &gt;  |  CRC  |____</div>
<div class="line">    m_wait_high_pulse       2, DRDY_PIN</div>
<div class="line"> </div>
<div class="line">    m_wait_nano_sec     10</div>
<div class="line">    m_pru_clr_pin       ADC_CS_PIN      ; set CS low</div>
<div class="line">    m_wait_nano_sec     10</div>
<div class="line"> </div>
<div class="line">    ;Fetch status register value using serial interface</div>
<div class="line">    m_read_packet_spi_mode1_msb_gpo_sclk       TEMP_REG_1, 24, R11.b0, SCLK_PIN, SDI_PIN, 8, 4</div>
<div class="line"> </div>
<div class="line">    ; Fetch samples using serial interface from each 8 channels</div>
<div class="line">    m_read_packet_spi_mode1_msb_gpo_sclk       ADC_DATA_REG_1, 24, R11.b0, SCLK_PIN, SDI_PIN, 8, 4</div>
<div class="line">    m_read_packet_spi_mode1_msb_gpo_sclk       ADC_DATA_REG_2, 24, R11.b0, SCLK_PIN, SDI_PIN, 8, 4</div>
<div class="line">    m_read_packet_spi_mode1_msb_gpo_sclk       ADC_DATA_REG_3, 24, R11.b0, SCLK_PIN, SDI_PIN, 8, 4</div>
<div class="line">    m_read_packet_spi_mode1_msb_gpo_sclk       ADC_DATA_REG_4, 24, R11.b0, SCLK_PIN, SDI_PIN, 8, 4</div>
<div class="line">    m_read_packet_spi_mode1_msb_gpo_sclk       ADC_DATA_REG_5, 24, R11.b0, SCLK_PIN, SDI_PIN, 8, 4</div>
<div class="line">    m_read_packet_spi_mode1_msb_gpo_sclk       ADC_DATA_REG_6, 24, R11.b0, SCLK_PIN, SDI_PIN, 8, 4</div>
<div class="line">    m_read_packet_spi_mode1_msb_gpo_sclk       ADC_DATA_REG_7, 24, R11.b0, SCLK_PIN, SDI_PIN, 8, 4</div>
<div class="line">    m_read_packet_spi_mode1_msb_gpo_sclk       ADC_DATA_REG_8, 24, R11.b0, SCLK_PIN, SDI_PIN, 8, 4</div>
<div class="line"> </div>
<div class="line">    ;Fetch crc register value using serial interface</div>
<div class="line">    m_read_packet_spi_mode1_msb_gpo_sclk       TEMP_REG_1, 24, R11.b0, SCLK_PIN, SDI_PIN, 8, 4</div>
<div class="line"> </div>
<div class="line">    m_wait_nano_sec     10</div>
<div class="line">    m_pru_set_pin       ADC_CS_PIN      ; set CS high</div>
<div class="line"> </div>
<div class="line">    ;Convert each sample to 32-bit</div>
<div class="line">    m_sign_ext          24, 32, ADC_DATA_REG_1, EXTEND_0</div>
<div class="line">    m_sign_ext          24, 32, ADC_DATA_REG_2, EXTEND_0</div>
<div class="line">    m_sign_ext          24, 32, ADC_DATA_REG_3, EXTEND_0</div>
<div class="line">    m_sign_ext          24, 32, ADC_DATA_REG_4, EXTEND_0</div>
<div class="line">    m_sign_ext          24, 32, ADC_DATA_REG_5, EXTEND_0</div>
<div class="line">    m_sign_ext          24, 32, ADC_DATA_REG_6, EXTEND_0</div>
<div class="line">    m_sign_ext          24, 32, ADC_DATA_REG_7, EXTEND_0</div>
<div class="line">    m_sign_ext          24, 32, ADC_DATA_REG_8, EXTEND_0</div>
<div class="line"> </div>
<div class="line">    ;Send samples to shared memory using ipc</div>
<div class="line">    ldi                 R1.b0, &amp;ADC_DATA_REG_1</div>
<div class="line">    m_pru_ipc_send      R1.b0, ADC_DATA_REG_1, R0.b0, R29, CONFIG_PRU_IPC0_RX_INTR_ENABLE, CONFIG_PRU_IPC0_RX_EVENT</div>
<div class="line"> </div>
<div class="line">    m_prgm_flow_jump_on_intr    PRGM_FLOW_EVENT, PRGM_FLOW_EVENT_BIT, 5, TEMP_REG_1, IDLE, SAMPLE_TRANSFER, ADC_CONFIG, READ_SAMPLES, RESET</div>
<div class="line"> </div>
<div class="line">    qba    START    ; loop to continue collecting samples</div>
<div class="line">    halt</div>
</div><!-- fragment --><dl class="section user"><dt></dt><dd>Tips to Modify PRU Firmware: Refer to <a href="../pru_macros_docs/index.html">PRU Source Macros Documentation</a> for making changes to PRU firmware. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
