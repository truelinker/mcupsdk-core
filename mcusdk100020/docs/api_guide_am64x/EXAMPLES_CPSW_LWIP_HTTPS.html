<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: CPSW Lwip HTTPS Server Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM64x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">10.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLES_CPSW_LWIP_HTTPS.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">CPSW Lwip HTTPS Server Example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md908">Introduction</a></li>
<li class="level1"><a href="#autotoc_md909">Supported Combinations</a></li>
<li class="level1"><a href="#autotoc_md910">Configuring Syscfg</a></li>
<li class="level1"><a href="#autotoc_md911">To Configure Static IP</a></li>
<li class="level1"><a href="#autotoc_md912">mbedTLS</a></li>
<li class="level1"><a href="#autotoc_md913">TLS certificates used</a><ul><li class="level2"><a href="#autotoc_md914">Certificate Authority</a></li>
<li class="level2"><a href="#autotoc_md915">Server Certificates</a></li>
<li class="level2"><a href="#autotoc_md916">Certificate Authority (Self signing)</a><ul><li class="level3"><a href="#autotoc_md917">Sample generated certificate</a></li>
<li class="level3"><a href="#autotoc_md918">Sample generated key</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md919">Steps to Run the Example</a><ul><li class="level2"><a href="#autotoc_md920">Build the example</a></li>
<li class="level2"><a href="#autotoc_md921">HW Setup</a></li>
<li class="level2"><a href="#autotoc_md922">Create a network between EVM and host PC</a></li>
<li class="level2"><a href="#autotoc_md923">Run the example</a></li>
<li class="level2"><a href="#autotoc_md924">Sample output for CPSW example</a></li>
<li class="level2"><a href="#autotoc_md925">Steps to execute</a></li>
<li class="level2"><a href="#autotoc_md926">Troubleshooting issues</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md927">See Also</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_examples_networking_cpsw_lwip_https"></a></p>
<h1><a class="anchor" id="autotoc_md908"></a>
Introduction</h1>
<dl class="section note"><dt>Note</dt><dd>LwIP and MbedTLS features are made available as is from the public lwIP and MbedTLS project. SDK configuration may only enable and exercise a subset of these features.</dd></dl>
<p>This example demonstates how to run a HTTPS server on LwIP networking stack using raw API coupled with ethernet driver (ENET), with MbedTLS providing TLS functionality in the L4 layer.</p>
<p>The mbedTLS public project being used here (tag 2.13.1) can be found here: <a href="https://github.com/Mbed-TLS/mbedtls/tree/mbedtls-2.13.1">https://github.com/Mbed-TLS/mbedtls/tree/mbedtls-2.13.1</a></p>
<p>On AM64X, we can do ethernet based communication using CPSW</p><ul>
<li>This is a standard ethernet switch + port HW</li>
<li>It uses the ethernet driver underneath with LwIP TCP/IP networking stack</li>
</ul>
<p>The example does below</p><ul>
<li>Initializes the ethernet driver for the underlying HW</li>
<li>Initializes the LwIP stack for TCP/UDP IP.</li>
<li>Gets an IP address assigned through DHCP and launches the HTTPS server.</li>
<li>HTTPS Server waits for connection from client on port 443.</li>
<li>On a client request coming from web browser, it uses MbedTLS to verify and complete TLS handshake.</li>
<li>HTTPS Server completes the handshake and sends back an "index.html" webpage back to client at the address {<a href="https://IP_ADDR/index.html">https://IP_ADDR/index.html</a>}.</li>
<li>This showcases the ability of the TI device to act as an HTTPS server </li>
</ul>
<h1><a class="anchor" id="autotoc_md909"></a>
Supported Combinations</h1>
<dl class="section note"><dt>Note</dt><dd>In this implementation of HTTPS server, we have used PBUF_RAM to allocate pbufs instead of PBUF_POOLS. This is subject to change in the future releases. The lwip-stack/src/apps/altcp_tls/altcp_tls_mbedtls.c file has also been moved out to the example for the aforementioned reason.</dd></dl>
<h1><a class="anchor" id="autotoc_md910"></a>
Configuring Syscfg</h1>
<ul>
<li>Following Syscfg option allows flexibility to configure memory foot print based on required use case like: Number of DMA descriptors and buffering.</li>
<li>Supported Options with default configuration</li>
</ul>
<table class="doxtable">
<tr>
<th>Feature </th><th>Section </th><th>Description </th><th><p class="starttd">Remarks/Default Setting </p>
<p class="endtd"></p>
</th></tr>
<tr>
<td>Mdio Manual Mode Enable </td><td>TI Networking / Enet (CPSW) </td><td>Flag to enable MDIO manual mode in example. Driver support for Manual mode is enabled, so this parameter configures manual mode in the example. </td><td><p class="starttd">Default is true. If your silicon is affected with errata <a href="https://www.ti.com/lit/er/sprz457e/sprz457e.pdf" target="_blank">i2329â€” MDIO interface corruption</a>, then TI suggests to use MDIO_MANUAL_MODE as software workaround. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Disable Mac Port1, Disable Mac Port2 </td><td>TI Networking / Enet (CPSW) </td><td>Select which port to Disable. </td><td><p class="starttd">Default is Port1 enabled. If both Port1 and Port 2 are enabled, any port can be used and if operating in switch mode, it enables traffic switching between the two ports. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Enable Packet Pool Allocation </td><td>TI Networking / Enet (CPSW) </td><td>Flag to enable packet allocation from enet utils library. It should be disabled to avoid utils memory wastage, in case application allots packet via other mechanism. (Ex- Lwip pools) </td><td><p class="starttd">Default is true. It is disabled for lwip based examples. If enabled size of pkt pool size depends on 'Large Pool Packet Size', 'Large Pool Packet Count', 'Medium Pool Packet Size', 'Medium Pool Packet Count', 'Small Pool Packet Size' and 'Small Pool Packet Count'. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Number of Tx Packet </td><td>TI Networking / Enet (CPSW) / DMA channel config </td><td>No of Tx packets required for DMA channel </td><td><p class="starttd">Default is 16. It contributes to the size of Pkt Mem Pool, DMA ring buffer and accessories. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Number of Rx Packet </td><td>TI Networking / Enet (CPSW) / DMA channel config </td><td>No of Rx packets required for DMA channel </td><td>Default is 40. It contributes to the size of Pkt Mem Pool, DMA ring buffer and accessories size.  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md911"></a>
To Configure Static IP</h1>
<p>Please refer to <a class="el" href="NETWORKING_LWIP_STATIC_IP.html">Ethernet LwIP TCP/IP Static IP</a>.</p>
<h1><a class="anchor" id="autotoc_md912"></a>
mbedTLS</h1>
<p>Mbed TLS is a C library that implements cryptographic primitives, X.509 certificate manipulation and the SSL/TLS and DTLS protocols. It is distributed under the Apache License version 2.0. Its small code footprint makes it suitable for embedded systems. It is known to be easy to understand, use, integrate and expand. The library is designed to integrate with existing (embedded) applications and to provide the building blocks for secure communication, cryptography and key management. It is designed to be as loosely coupled as possible, allowing you to only integrate the parts you need without having overhead from the rest.</p>
<ul>
<li>mbedTLS tag used for this example: mbedtls-2.13.1 (<a href="https://github.com/Mbed-TLS/mbedtls/tree/mbedtls-2.13.1">https://github.com/Mbed-TLS/mbedtls/tree/mbedtls-2.13.1</a>)</li>
</ul>
<h1><a class="anchor" id="autotoc_md913"></a>
TLS certificates used</h1>
<p>Here we use self signed openSSL generated certificates for TLS handshake. The steps for generation of certificate are shown below. First we generate the certificates and then convert it to DER format, which is further converted to hex and used in "server_certificates.h" file.</p>
<h2><a class="anchor" id="autotoc_md914"></a>
Certificate Authority</h2>
<ul>
<li>Generate unencrypted 2048-bits RSA private key for the certificate authority (CA). <div class="fragment"><div class="line">$ openssl genrsa -out ca-prk.pem 2048</div>
</div><!-- fragment --></li>
<li>Generate certificate signing request (CSR) for the CA <div class="fragment"><div class="line">$ openssl req -new -sha256 -key ca-prk.pem -out ca-csr.pem -subj &quot;/C={country}/ST={state}/L={locality}/O={organization} CA&quot;</div>
</div><!-- fragment --></li>
<li>Self-sign the CSR and to generate a certificate for the CA <div class="fragment"><div class="line">$ openssl x509 -req -signkey ca-prk.pem -in ca-csr.pem -out ca-cer.pem -days 3650</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md915"></a>
Server Certificates</h2>
<ul>
<li>Generate unencrypted 2048-bits RSA private key for the server (CA) <div class="fragment"><div class="line">$ openssl genrsa -out server-prk.pem 2048</div>
</div><!-- fragment --></li>
<li>Generate CSR for the server <div class="fragment"><div class="line">$ openssl req -new -sha256 -key server-prk.pem -out server-csr.pem -subj &quot;/C={country}/ST={state}/L={locality}/O={organization}/CN={common name, ex. 127.0.0.1}&quot;</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md916"></a>
Certificate Authority (Self signing)</h2>
<ul>
<li>View the server CSR and verify its content: <div class="fragment"><div class="line">$ openssl req -in server-csr.pem -noout -text</div>
</div><!-- fragment --></li>
<li>Sign the server CSR <div class="fragment"><div class="line">$ openssl x509 -req -sha256 -in server-csr.pem -CA ca-cer.pem -CAkey ca-prk.pem -CAcreateserial -out server-cer.pem -days 365</div>
</div><!-- fragment --></li>
<li>Follow the steps below to convert certificates from PEM to DER format <div class="fragment"><div class="line">$ openssl x509 -outform der -in ca-cer.pem -out certificate.der</div>
<div class="line">$ openssl rsa -outform der -in ca-prk.pem -out keys.der</div>
</div><!-- fragment --></li>
<li>Convert .pem and .key files to byte array. This will produce a header file with the byte array of certificate/key and the size of the array <div class="fragment"><div class="line">$ xxd -i keys.der keys.h</div>
<div class="line">$ xxd -i certificate.der certificate.h</div>
</div><!-- fragment --></li>
</ul>
<dl class="section note"><dt>Note</dt><dd>In this implementation of HTTPS server, we have not enabled the file system support. We directly use the certificate's and key's data as hex dump array. The server_certificates.h file has both the Certificate and the private key. The variable 'Certificate' is the hex dump of certificate.pem and the variable 'PrivateKey' is the hex dump of key.pem.</dd></dl>
<h3><a class="anchor" id="autotoc_md917"></a>
Sample generated certificate</h3>
<p> <style>div.image img[src="cpsw_lwip_https_cert1.png"]{width:70%}</style> </p><div class="image">
<img src="cpsw_lwip_https_cert1.png" alt=""/>
</div>
<p>  <style>div.image img[src="cpsw_lwip_https_cert2.png"]{width:70%}</style> </p><div class="image">
<img src="cpsw_lwip_https_cert2.png" alt=""/>
</div>
<h3><a class="anchor" id="autotoc_md918"></a>
Sample generated key</h3>
<p> <style>div.image img[src="cpsw_lwip_https_key.png"]{width:70%}</style> </p><div class="image">
<img src="cpsw_lwip_https_key.png" alt=""/>
</div>
<h1><a class="anchor" id="autotoc_md919"></a>
Steps to Run the Example</h1>
<h2><a class="anchor" id="autotoc_md920"></a>
Build the example</h2>
<ul>
<li>When using CCS projects to build, import the CCS project for the required combination and build it using the CCS project menu (see <a class="el" href="CCS_PROJECTS_PAGE.html">Using SDK with CCS Projects</a>).</li>
<li>When using makefiles to build, note the required combination and build using make command (see <a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
</ul>
<h2><a class="anchor" id="autotoc_md921"></a>
HW Setup</h2>
<dl class="section note"><dt>Note</dt><dd>Make sure you have setup the EVM with cable connections as shown here, <a class="el" href="EVM_SETUP_PAGE.html">EVM Setup</a>. In addition do below steps.</dd></dl>
<h2><a class="anchor" id="autotoc_md922"></a>
Create a network between EVM and host PC</h2>
<ul>
<li>The EVM will get an IP address using DHCP, so make sure to connect the other end of the cable to a network which has a DHCP server running.</li>
<li>To get started one can create a simple local network between the EVM and the host PC by using a home broadband/wifi router as shown below. Most such routers run a DHCP server</li>
</ul>
<p> <style>div.image img[src="lwip_example_01.png"]{width:30%}</style> </p><div class="image">
<img src="lwip_example_01.png" alt=""/>
<div class="caption">
Local network between PC and EVM</div></div>
<ul>
<li>To check the router connection with host PC, recommend to disconnect all other networking conenctions on the PC, sometimes you may need to disable firewall SW, and make sure the router is able to assign a IP address to your host PC</li>
<li>After we run the example on the EVM (next step), the EVM will similarly be assigned a IP address, and then host can communicate with the EVM using the assigned IP address.</li>
<li>To enable static IP, set the static IP in the ipAddr variable in the App_setupNetif() before passing it as arguement to initiate the netif, and stop the dhcp from starting in the App_allocateIPAddress() function.</li>
</ul>
<h2><a class="anchor" id="autotoc_md923"></a>
Run the example</h2>
<dl class="section attention"><dt>Attention</dt><dd>If you need to reload and run again, a CPU power-cycle is MUST</dd></dl>
<ul>
<li>Launch a CCS debug session and run the example executable, see <a class="el" href="CCS_LAUNCH_PAGE.html">CCS Launch, Load and Run</a></li>
<li>You will see logs in the UART terminal as shown in the next section.</li>
<li>Note the IP address seen in the log, this is what we will use to communicate with the EVM via a Web Browser. The address in this case is <a href="https://192.168.1.2/index.html">https://192.168.1.2/index.html</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md924"></a>
Sample output for CPSW example</h2>
<div class="fragment"><div class="line">==========================</div>
<div class="line">       CPSW HTTPS TCP</div>
<div class="line">==========================</div>
<div class="line">Enabling clocks!</div>
<div class="line">EnetAppUtils_reduceCoreMacAllocation: Reduced Mac Address Allocation for CoreId:1 From 4 To 2</div>
<div class="line">Mdio_open: MDIO Manual_Mode enabled</div>
<div class="line">EnetPhy_bindDriver: PHY 0: OUI:080028 Model:23 Ver:01 &lt;-&gt; &#39;dp83867&#39; : OK</div>
<div class="line">PHY 0 is alive</div>
<div class="line">Starting lwIP, local interface IP is dhcp-enabled</div>
<div class="line">Host MAC address-0 : f4:84:4c:f9:86:e9</div>
<div class="line">[LWIPIF_LWIP] NETIF INIT SUCCESS</div>
<div class="line">[LWIPIF_LWIP] Enet has been started successfully</div>
<div class="line">Enet IF UP Event. Local interface IP:0.0.0.0</div>
<div class="line">Waiting for network UP ...</div>
<div class="line">Waiting for network UP ...</div>
<div class="line">Cpsw_handleLinkUp: Port 1: Link up: 100-Mbps Full-Duplex</div>
<div class="line">MAC Port 1: link up</div>
<div class="line">Network Link UP Event</div>
<div class="line">Waiting for network UP ...</div>
<div class="line">Waiting for network UP ...</div>
<div class="line">Enet IF UP Event. Local interface IP:192.168.1.2</div>
<div class="line">Network is UP ...</div>
<div class="line">     14. 94s : CPU load =   2.90 %</div>
<div class="line">     19. 95s : CPU load =   32.60 %</div>
<div class="line">     24. 96s : CPU load =   24.65 %</div>
<div class="line">     29. 97s : CPU load =   12.64 %</div>
<div class="line">     34. 98s : CPU load =   5.63 %</div>
<div class="line">     39. 99s : CPU load =   2.94 %</div>
</div><!-- fragment --><ul>
<li>Sample output of client (web browser)</li>
</ul>
<p> <style>div.image img[src="cpsw_lwip_https_server.png"]{width:80%}</style> </p><div class="image">
<img src="cpsw_lwip_https_server.png" alt=""/>
<div class="caption">
Client web browser connected to HTTPS server</div></div>
<h2><a class="anchor" id="autotoc_md925"></a>
Steps to execute</h2>
<ol type="1">
<li>Run example on EVM</li>
<li>Try to reach the EVM using ping as shown below, using a command shell on the host PC <div class="fragment"><div class="line">$ping 192.168.1.2</div>
</div><!-- fragment --> "192.168.1.2" should be replaced with IP of EVM.</li>
<li>To start the client on host PC, open a web browser of your choice and enter url <a href="https://IP_ADDR/index.html">https://IP_ADDR/index.html</a> Replace IP_ADDR with the EVM IP assigned during run-time. The above has been tried with google chrome, microsoft edge, mozilla firefox.</li>
<li>The lwIP home page will load with the title "lwip -  A Lightweight TCP/IP Stack"</li>
<li>To close the connection, simply close the tab in the web broswer.</li>
</ol>
<h2><a class="anchor" id="autotoc_md926"></a>
Troubleshooting issues</h2>
<ul>
<li>If you see MAC address as <code>00:00:00:00:00:00</code>, likely you are using a very early Si sample which does not have MAC address "fused" in, in this case do below steps<ul>
<li>Open file <code>source/networking/.meta/enet_cpsw/templates/am64x_am243x/enet_soc_cfg.c.xdt</code></li>
<li>Uncomment below line <div class="fragment"><div class="line">#define ENET_MAC_ADDR_HACK (TRUE)</div>
</div><!-- fragment --></li>
<li>Rebuild the libraries and examples (<a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
</ul>
</li>
<li>If you see a valid, non-zero MAC address and continuosly seieing "Waiting for network UP..." prints in UART terminal<ul>
<li>Make sure you see <code>Enet IF UP Event.</code> message, if not check the ethernet cable</li>
<li>Check the local network and check if the DHCP server is indeed running as expected</li>
<li>When using a home broadband/wifi router, its possible to check the clients connected to the DHCP server via a web browser. Check your router user manual for more details.</li>
</ul>
</li>
<li>If you see "address cannot be reached" message in the client browser,<ul>
<li>Make sure you see the <code>Enet IF UP Event</code> message, if not check the connection of router, host PC and EVM</li>
<li>Make sure a valid Local Interface IP is assigned.</li>
</ul>
</li>
<li>If the client fails at loading index.html<ul>
<li>Make sure the certificate is valid and the hex dump is loaded correctly for certificate and key in server_certificates.h files</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md927"></a>
See Also</h1>
<p><a class="el" href="NETWORKING.html">Ethernet And Networking</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
