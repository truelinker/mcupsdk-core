<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: CPSW Lwip MQTT Client Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM64x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">10.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLES_CPSW_LWIP_MQTT.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">CPSW Lwip MQTT Client Example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md928">Introduction</a></li>
<li class="level1"><a href="#autotoc_md929">Supported Combinations</a></li>
<li class="level1"><a href="#autotoc_md930">Configuring Syscfg</a></li>
<li class="level1"><a href="#autotoc_md931">To Configure Static IP</a></li>
<li class="level1"><a href="#autotoc_md932">mbedTLS</a></li>
<li class="level1"><a href="#autotoc_md933">TLS certificates</a><ul><li class="level2"><a href="#autotoc_md934">Generate Certificates</a><ul><li class="level3"><a href="#autotoc_md935">Sample generated certificate</a></li>
<li class="level3"><a href="#autotoc_md936">Sample generated key</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md937">Mosquitto Broker Configurations</a></li>
<li class="level1"><a href="#autotoc_md938">Steps to Run the Example</a><ul><li class="level2"><a href="#autotoc_md939">Build the example</a></li>
<li class="level2"><a href="#autotoc_md940">HW Setup</a></li>
<li class="level2"><a href="#autotoc_md941">Create a network between EVM and host PC</a></li>
<li class="level2"><a href="#autotoc_md942">Steps to execute</a></li>
<li class="level2"><a href="#autotoc_md943">Sample output for MQTT example</a></li>
<li class="level2"><a href="#autotoc_md944">Troubleshooting issues</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md945">See Also</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_examples_networking_cpsw_lwip_mqtt"></a></p>
<h1><a class="anchor" id="autotoc_md928"></a>
Introduction</h1>
<dl class="section note"><dt>Note</dt><dd>LwIP and MbedTLS features are made available as is from the public lwIP and MbedTLS project. SDK configuration may only enable and exercise a subset of these features. The mbedTLS public project being used here (tag 2.13.1) can be found here: <a href="https://github.com/Mbed-TLS/mbedtls/tree/mbedtls-2.13.1">https://github.com/Mbed-TLS/mbedtls/tree/mbedtls-2.13.1</a></dd></dl>
<p>This example demonstates how to run a MQTT client with TLS enabled on LwIP networking stack using raw API coupled with ethernet driver (ENET), with MbedTLS providing TLS functionality in the L4 layer.</p>
<p>On AM64X, we can do ethernet based communication using CPSW</p><ul>
<li>This is a standard ethernet switch + port HW</li>
<li>It uses the ethernet driver underneath with LwIP TCP/IP networking stack</li>
</ul>
<p>The example does below</p><ul>
<li>Initializes the ethernet driver for the underlying HW</li>
<li>Initializes the LwIP stack for TCP/UDP IP.</li>
<li>Client gets a static IP address and launches the MQTT client connection request.</li>
<li>Based on the mode selected from app_main.c, the MQTT client acts as a subscriber or publisher</li>
<li>MQTT broker waits for connection from client on port 1883 (TLS disabled) or port 8883 (TLS enabled).</li>
<li>When the broker receives a connection request from the MQTT Client (AM2x device), a 2way Auth is completed and both the broker and client are verified by a TLS handshake</li>
<li>After the handshake is complete, if publisher mode is selected, the client will publish the message entered by user in the console, else it will subscribe to the broker</li>
<li>This showcases the ability of the TI device to act as an MQTT client and interact with an MQTT broker. </li>
</ul>
<h1><a class="anchor" id="autotoc_md929"></a>
Supported Combinations</h1>
<dl class="section note"><dt>Note</dt><dd>In this example, we have used PBUF_RAM to allocate pbufs instead of PBUF_POOLS. This is subject to change in the future releases. The lwip-stack/src/apps/altcp_tls/altcp_tls_mbedtls.c file has also been moved to the example for the aforementioned reason.</dd>
<dd>
To use MQTT without TLS, in "cpsw_lwip_mqtt/mqtt.h", set MQTT_HAVE_TLS to 0, and rebuild the example</dd></dl>
<h1><a class="anchor" id="autotoc_md930"></a>
Configuring Syscfg</h1>
<ul>
<li>Following Syscfg option allows flexibility to configure memory foot print based on required use case like: Number of DMA descriptors and buffering.</li>
<li>Supported Options with default configuration</li>
</ul>
<table class="doxtable">
<tr>
<th>Feature </th><th>Section </th><th>Description </th><th><p class="starttd">Remarks/Default Setting </p>
<p class="endtd"></p>
</th></tr>
<tr>
<td>Mdio Manual Mode Enable </td><td>TI Networking / Enet (CPSW) </td><td>Flag to enable MDIO manual mode in example. Driver support for Manual mode is enabled, so this parameter configures manual mode in the example. </td><td><p class="starttd">Default is true. If your silicon is affected with errata <a href="https://www.ti.com/lit/er/sprz457e/sprz457e.pdf" target="_blank">i2329â€” MDIO interface corruption</a>, then TI suggests to use MDIO_MANUAL_MODE as software workaround. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Disable Mac Port1, Disable Mac Port2 </td><td>TI Networking / Enet (CPSW) </td><td>Select which port to Disable </td><td><p class="starttd">Default is Port1 enabled. If both Port1 and Port 2 are enabled, any port can be used and if operating in switch mode, it enables traffic switching between the two ports. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Enable Packet Pool Allocation </td><td>TI Networking / Enet (CPSW) </td><td>Flag to enable packet allocation from enet utils library. It should be disabled to avoid utils memory wastage, in case application allots packet via other mechanism. (Ex- Lwip pools) </td><td><p class="starttd">Default is true. It is disabled for lwip based examples. If enabled size of pkt pool size depends on 'Large Pool Packet Size', 'Large Pool Packet Count', 'Medium Pool Packet Size', 'Medium Pool Packet Count', 'Small Pool Packet Size' and 'Small Pool Packet Count'. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Number of Tx Packet </td><td>TI Networking / Enet (CPSW) / DMA channel config </td><td>No of Tx packets required for DMA channel </td><td><p class="starttd">Default is 16. It contributes to the size of Pkt Mem Pool, DMA ring buffer and accessories. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Number of Rx Packet </td><td>TI Networking / Enet (CPSW) / DMA channel config </td><td>No of Rx packets required for DMA channel </td><td>Default is 40. It contributes to the size of Pkt Mem Pool, DMA ring buffer and accessories size.  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md931"></a>
To Configure Static IP</h1>
<p>Please refer to <a class="el" href="NETWORKING_LWIP_STATIC_IP.html">Ethernet LwIP TCP/IP Static IP</a>.</p>
<h1><a class="anchor" id="autotoc_md932"></a>
mbedTLS</h1>
<p>Mbed TLS is a C library that implements cryptographic primitives, X.509 certificate manipulation and the SSL/TLS and DTLS protocols. It is distributed under the Apache License version 2.0. Its small code footprint makes it suitable for embedded systems. It is known to be easy to understand, use, integrate and expand. The library is designed to integrate with existing (embedded) applications and to provide the building blocks for secure communication, cryptography and key management. It is designed to be as loosely coupled as possible, allowing you to only integrate the parts you need without having overhead from the rest.</p>
<ul>
<li>mbedTLS tag used for this example: mbedtls-2.13.1 (<a href="https://github.com/Mbed-TLS/mbedtls/tree/mbedtls-2.13.1">https://github.com/Mbed-TLS/mbedtls/tree/mbedtls-2.13.1</a>)</li>
</ul>
<h1><a class="anchor" id="autotoc_md933"></a>
TLS certificates</h1>
<p>Here we use self signed openSSL generated certificates for TLS handshake. The steps for generation of certificate are shown below. The mosquitto broker accepts certificates in PEM (.crt extension) format. The format for client certificates used in the SDK code is DER format in the form of binary data.</p>
<p>The certificates needed here are:</p><ol type="1">
<li>Server certificates</li>
<li>CA certificartes</li>
</ol>
<p>The client certificates can be shared across multiple clients. For simplicity we use "1234" as passwords for all the certificates and broker configuration.</p>
<dl class="section note"><dt>Note</dt><dd>In this implementation of MQTT client, we have not enabled the file system support. We directly use the certificate's and key's data in binary form. The client_info.h file has both the Certificate, the private key, the CA details and the password. The variables are required by mqtt.c to perform a 2way authentication.</dd></dl>
<h2><a class="anchor" id="autotoc_md934"></a>
Generate Certificates</h2>
<ul>
<li>Create Key pair for Certificate authority (CA). <div class="fragment"><div class="line">$ oopenssl genrsa -des3 -out ca.key 2048</div>
</div><!-- fragment --></li>
<li>Generate certificate for CA using above key <div class="fragment"><div class="line">$ openssl req -new -x509 -days 1826 -key ca.key -out ca.crt</div>
</div><!-- fragment --></li>
<li>Create server key pair for the server, to be used by the broker <div class="fragment"><div class="line">$ openssl genrsa -out server.key 2048</div>
</div><!-- fragment --></li>
<li>Create a Certificate Sign Request (csr) for the server <div class="fragment"><div class="line">$ openssl req -new -out server.csr -key server.key</div>
</div><!-- fragment --></li>
<li>Self sign the Server certificates using CA key <div class="fragment"><div class="line">$ openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 360</div>
</div><!-- fragment --></li>
<li>To convert certificates from PEM to DER format. Convert both CA and server certificates <div class="fragment"><div class="line">$ openssl x509 -outform der -in ca.pem -out ca.crt</div>
<div class="line">$ openssl rsa -outform der -in ca.key -out ca.key</div>
</div><!-- fragment --></li>
<li>To convert DER certificates to binary data, this data is used in client_info.h <div class="fragment"><div class="line">xxd -i filename.der filename.h</div>
</div><!-- fragment --></li>
</ul>
<dl class="section note"><dt>Note</dt><dd>In case of linux, "/etc/mosquitto/ca_certificates" is the directory where the CA keys and certificates should be placed. The server certificates should be placed in mosquitto/certs folder.</dd></dl>
<h3><a class="anchor" id="autotoc_md935"></a>
Sample generated certificate</h3>
<p> <style>div.image img[src="cpsw_lwip_https_cert1.png"]{width:70%}</style> </p><div class="image">
<img src="cpsw_lwip_https_cert1.png" alt=""/>
</div>
<p>  <style>div.image img[src="cpsw_lwip_https_cert2.png"]{width:70%}</style> </p><div class="image">
<img src="cpsw_lwip_https_cert2.png" alt=""/>
</div>
<h3><a class="anchor" id="autotoc_md936"></a>
Sample generated key</h3>
<p> <style>div.image img[src="cpsw_lwip_https_key.png"]{width:70%}</style> </p><div class="image">
<img src="cpsw_lwip_https_key.png" alt=""/>
</div>
<h1><a class="anchor" id="autotoc_md937"></a>
Mosquitto Broker Configurations</h1>
<ul>
<li>Install Mosquitto broker and clients <div class="fragment"><div class="line">sudo apt-get install mosquitto</div>
<div class="line">sudo apt-get install mosquitto-clients</div>
</div><!-- fragment --></li>
<li>Create a Password file with users, for simplicity, we use "1234" as password for all 3 users <div class="fragment"><div class="line">./apps/mosquitto_passwd/mosquitto_passwd -c my_password_file am243x_evm (or any other username)</div>
<div class="line">./apps/mosquitto_passwd/mosquitto_passwd my_password_file pc_sub</div>
<div class="line">./apps/mosquitto_passwd/mosquitto_passwd my_password_file pc_pub</div>
</div><!-- fragment --></li>
<li>Create your own copy of the ACL file, add all users created above <div class="fragment"><div class="line">cp aclfile.example my_aclfile</div>
<div class="line"># Sitara Device client</div>
<div class="line">user am243x_evm (or any other username)</div>
<div class="line">topic topic_qos1</div>
<div class="line"> </div>
<div class="line"># Linux PC - Subscriber</div>
<div class="line">user pc_sub</div>
<div class="line">topic topic_qos1</div>
<div class="line"> </div>
<div class="line"># Linux PC - Publisher</div>
<div class="line">user pc_pub</div>
<div class="line">topic topic_qos1</div>
</div><!-- fragment --></li>
<li>Create your own copy of mosquitto.conf <div class="fragment"><div class="line">cp mosquitto.conf my_mosquitto.conf</div>
</div><!-- fragment --></li>
<li>Make the following changes according to the diff shown below <div class="fragment"><div class="line">a0503581@a0503581:~/mosquitto$ diff mosquitto.conf my_mosquitto.conf</div>
<div class="line">37c37</div>
<div class="line">&lt; #per_listener_settings false</div>
<div class="line">---</div>
<div class="line">&gt; per_listener_settings true</div>
<div class="line">234c234</div>
<div class="line">&lt; #listener</div>
<div class="line">---</div>
<div class="line">&gt; listener 8883 10.24.69.98</div>
<div class="line">257c257</div>
<div class="line">&lt; #bind_interface</div>
<div class="line">---</div>
<div class="line">&gt; bind_interface enp0s31f6</div>
<div class="line">312d311</div>
<div class="line">&lt; # enabled for any listener.</div>
<div class="line">318c317</div>
<div class="line">&lt; #certfile</div>
<div class="line">---</div>
<div class="line">&gt; certfile /home/a0503581/mosquitto/certs/server.crt</div>
<div class="line">321c320,322</div>
<div class="line">&lt; #keyfile</div>
<div class="line">---</div>
<div class="line">&gt; keyfile /home/a0503581/mosquitto/certs/server.key</div>
<div class="line">&gt;</div>
<div class="line">&gt; tls_version tlsv1.2</div>
<div class="line">352c353</div>
<div class="line">&lt; #require_certificate false</div>
<div class="line">---</div>
<div class="line">&gt; require_certificate true</div>
<div class="line">362,364c363,364</div>
<div class="line">&lt; #cafile</div>
<div class="line">&lt; #capath</div>
<div class="line">&lt;</div>
<div class="line">---</div>
<div class="line">&gt; cafile /etc/mosquitto/ca_certificates/ca.crt</div>
<div class="line">&gt; #capath /home/a0503581/mosquitto/certs</div>
<div class="line">532c532</div>
<div class="line">&lt; #allow_anonymous false</div>
<div class="line">---</div>
<div class="line">&gt; allow_anonymous true</div>
<div class="line">550c550</div>
<div class="line">&lt; #password_file</div>
<div class="line">---</div>
<div class="line">&gt; password_file my_password_file</div>
<div class="line">613c613</div>
<div class="line">&lt; #acl_file</div>
<div class="line">---</div>
<div class="line">&gt; acl_file my_aclfile</div>
</div><!-- fragment --></li>
</ul>
<dl class="section note"><dt>Note</dt><dd>To run the same example without TLS, the mosquitto.conf file should use port 1883 instead of 8883 and "require_certificates" should be set to false, the capath, certfile path should be removed </dd></dl>
<h1><a class="anchor" id="autotoc_md938"></a>
Steps to Run the Example</h1>
<h2><a class="anchor" id="autotoc_md939"></a>
Build the example</h2>
<ul>
<li>When using CCS projects to build, import the CCS project for the required combination and build it using the CCS project menu (see <a class="el" href="CCS_PROJECTS_PAGE.html">Using SDK with CCS Projects</a>).</li>
<li>When using makefiles to build, note the required combination and build using make command (see <a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
</ul>
<h2><a class="anchor" id="autotoc_md940"></a>
HW Setup</h2>
<dl class="section note"><dt>Note</dt><dd>Make sure you have setup the EVM with cable connections as shown here, <a class="el" href="EVM_SETUP_PAGE.html">EVM Setup</a>. In addition do below steps.</dd></dl>
<h2><a class="anchor" id="autotoc_md941"></a>
Create a network between EVM and host PC</h2>
<ul>
<li>The EVM will get an IP address statically (192.168.1.3), so make sure to connect the other end of the cable to a linux PC (192.168.1.2) running the mosquitto broker.</li>
</ul>
<p> <style>div.image img[src="mqtt_connections.png"]{width:45%}</style> </p><div class="image">
<img src="mqtt_connections.png" alt=""/>
<div class="caption">
Local network between PC and EVM</div></div>
<ul>
<li>To check the router connection with host PC, recommend to disconnect all other networking conenctions on the PC, sometimes you may need to disable firewall SW, and make sure the IP address of the linux PC is correct.</li>
</ul>
<h2><a class="anchor" id="autotoc_md942"></a>
Steps to execute</h2>
<ol type="1">
<li>On a linux terminal, launch the broker using the command: "./src/mosquitto -c my_mosquitto.conf -v"</li>
<li>Run the example on the TI Sitara device (AM64X).</li>
</ol>
<ol type="1">
<li>Try to reach the EVM using ping as shown below, using a command shell on the host PC <div class="fragment"><div class="line">$ping 192.168.1.3</div>
</div><!-- fragment --></li>
<li>The client (192.168.1.3) will attempt to make a connection with the broker (192.168.1.2) and after the TLS handshake is complete, the broker logs will display a message for new connection</li>
<li>In another linux terminal, use the command to publish data to a topic which the client has subscribed to: <div class="fragment"><div class="line">sudo LD_LIBRARY_PATH=./lib ./client/mosquitto_pub -h 192.168.1.2 -u pc_pub -P 1234 -t topic_qos1 --cafile /etc/mosquitto/ca_certificates/ca.crt  --cert {PATH_TO_BROKER}/mosquitto/certs/server.crt --key {PATH_TO_BROKER}/mosquitto/certs/server.key --debug --insecure --tls-version tlsv1.2 -m &quot;helloworld&quot;</div>
</div><!-- fragment --></li>
<li>The broker and client output has been displayed above.</li>
<li>There will be constant PING messages shared between client and broker to keep the connection alive.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd>For MQTT without TLS, use the conf file created for Non TLS broker, Steps 1-3 remain same, for publishing data, use the following command: LD_LIBRARY_PATH=./lib ./client/mosquitto_pub -h BROKER_IP -u pc_pub -P 1234 -t topic_qos1 -m 'helloworld' </dd></dl>
<h2><a class="anchor" id="autotoc_md943"></a>
Sample output for MQTT example</h2>
<ul>
<li>Sample terminal output (TI device) The subscriber connection (named "test" here) received a message on topic (topic_qos1) of lenght 10 ("helloworld")</li>
</ul>
<div class="fragment"><div class="line">==========================</div>
<div class="line">  CPSW LWIP MQTT + TLS</div>
<div class="line">==========================</div>
<div class="line">Enabling clocks!</div>
<div class="line">Mdio_open: MDIO Manual_Mode enabled</div>
<div class="line">EnetPhy_bindDriver: PHY 0: OUI:080028 Model:23 Ver:01 &lt;-&gt; &#39;dp83867&#39; : OK</div>
<div class="line">PHY 0 is alive</div>
<div class="line">Starting lwIP, local interface IP is Statically assigned</div>
<div class="line">Host MAC address-0 : ac:1f:0f:84:0c:70</div>
<div class="line">[LWIPIF_LWIP] NETIF INIT SUCCESS</div>
<div class="line">Enet IF UP Event. Local interface IP:192.168.1.3</div>
<div class="line">[LWIPIF_LWIP] Enet has been started successfully</div>
<div class="line">Waiting for network UP ...</div>
<div class="line">Waiting for network UP ...</div>
<div class="line">Waiting for network UP ...</div>
<div class="line">Cpsw_handleLinkUp: Port 1: Link up: 1-Gbps Full-Duplex</div>
<div class="line">MAC Port 1: link up</div>
<div class="line">Network Link UP Event</div>
<div class="line">Network is UP ...</div>
<div class="line">MQTT Client connection accepted</div>
<div class="line">MQTT Client &quot;test&quot; connection accepted</div>
<div class="line">MQTT Client &quot;test&quot; connection accepted</div>
<div class="line">     12. 87s : CPU load =  11.65 %</div>
<div class="line">MQTT client &quot;test&quot; subscribed to topic: topic_qos1</div>
<div class="line">MQTT client &quot;test&quot; data received: helloworld, data len: 10 bytes</div>
<div class="line">     17. 88s : CPU load =   2.38 %</div>
</div><!-- fragment --><ul>
<li>Sample output of broker (Linux terminal)</li>
</ul>
<p> <style>div.image img[src="cpsw_lwip_mqtt_broker.png"]{width:80%}</style> </p><div class="image">
<img src="cpsw_lwip_mqtt_broker.png" alt=""/>
<div class="caption">
Mosquitto broker output</div></div>
<ul>
<li>Sample output of publish command (Linux terminal)</li>
</ul>
<p> <style>div.image img[src="cpsw_lwip_mqtt_publish.png"]{width:80%}</style> </p><div class="image">
<img src="cpsw_lwip_mqtt_publish.png" alt=""/>
<div class="caption">
Client output in terminal</div></div>
<h2><a class="anchor" id="autotoc_md944"></a>
Troubleshooting issues</h2>
<ul>
<li>If you see MAC address as <code>00:00:00:00:00:00</code>, likely you are using a very early Si sample which does not have MAC address "fused" in, in this case do below steps<ul>
<li>Open file <code>source/networking/.meta/enet_cpsw/templates/am64x_am243x/enet_soc_cfg.c.xdt</code></li>
<li>Uncomment below line <div class="fragment"><div class="line">#define ENET_MAC_ADDR_HACK (TRUE)</div>
</div><!-- fragment --></li>
<li>Rebuild the libraries and examples (<a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
</ul>
</li>
<li>If you see a valid, non-zero MAC address and continuosly seieing "Waiting for network UP..." prints in UART terminal<ul>
<li>Make sure you see <code>Enet IF UP Event.</code> message, if not check the ethernet cable</li>
</ul>
</li>
<li>If the TLS handshake fails:<ul>
<li>Make sure the client_info.h file has valid certificates for client and CA and valid password.</li>
</ul>
</li>
<li>For LwIP related error codes, refer:<ul>
<li><a href="https://www.nongnu.org/lwip/2_0_x/group__infrastructure__errors.html">https://www.nongnu.org/lwip/2_0_x/group__infrastructure__errors.html</a></li>
</ul>
</li>
<li>For MQTT Error codes, refer the file at path:<ul>
<li>/lwip/lwip-stack/src/include/lwip/apps/mqtt.h</li>
</ul>
</li>
<li>To check the broker configuration, a mosquitto subscriber and publisher can be used on the linux PC<ul>
<li>To launch the broker <div class="fragment"><div class="line">./src/mosquitto -c my_mosquitto.conf -v</div>
</div><!-- fragment --></li>
<li>To subscribe using mosquitto subscriber <div class="fragment"><div class="line">sudo LD_LIBRARY_PATH=./lib ./client/mosquitto_sub -h 192.168.1.2 -u pc_sub -P 1234 -t topic_qos1 --cafile /etc/mosquitto/ca_certificates/ca.crt --cert /home/a0503581/mosquitto/certs/server.crt --key /home/a0503581/mosquitto/certs/server.key --debug --insecure --tls-version tlsv1.2</div>
</div><!-- fragment --></li>
<li>To publish using mosquitto publisher <div class="fragment"><div class="line">sudo LD_LIBRARY_PATH=./lib ./client/mosquitto_pub -h 192.168.1.2 -u pc_pub -P 1234 -t topic_qos1 --cafile /etc/mosquitto/ca_certificates/ca.crt  --cert /home/a0503581/mosquitto/certs/server.crt --key /home/  a0503581/mosquitto/certs/server.key --debug --insecure --tls-version tlsv1.2 -m &quot;helloworld&quot;</div>
</div><!-- fragment --></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md945"></a>
See Also</h1>
<p><a class="el" href="NETWORKING.html">Ethernet And Networking</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
