<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: HS FS Migration Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM64x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">10.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('HSFS_MIGRATION_GUIDE.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">HS FS Migration Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md320">System Firmware</a></li>
<li class="level1"><a href="#autotoc_md321">NON-SBL Example Appimage Build</a></li>
<li class="level1"><a href="#autotoc_md322">SBL Application Build</a></li>
<li class="level1"><a href="#SBL_BOOT_HS_FS">Application boot using SBL (SBL OSPI, SBL NULL, SBL UART, SBL SD etc.)</a></li>
<li class="level1"><a href="#CCS_BOOT_HS_FS">Application boot using CCS + GELs</a></li>
<li class="level1"><a href="#autotoc_md323">Difference of SYSFW loading in SBL mode and CCS mode in HS-FS</a></li>
<li class="level1"><a href="#autotoc_md324">Firewall Configurations</a></li>
<li class="level1"><a href="#autotoc_md325">Summary of differences in GP vs HS-FS</a></li>
<li class="level1"><a href="#autotoc_md326">Signing of Images in GP vs HS-FS</a><ul><li class="level2"><a href="#autotoc_md327">SYSFW Signing</a></li>
<li class="level2"><a href="#autotoc_md328">SBL Signing</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md329">Appimage Signing</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_migration_guides_hs_fs_migration_guide"></a></p>
<p>The MCU+SDK primarily supports <b>HS-FS</b> (High Security - Field Securable) as the main device and the support for GP is deprecated. This document aims to list out the differences between the two device types and aid the users to develop on HS-FS device type.</p>
<h1><a class="anchor" id="autotoc_md320"></a>
System Firmware</h1>
<p>One of the major differences between GP and HS-FS is System Firmware (SYSFW). In both devices, SYSFW is always signed with an asymmetric key (RSA/ECC) and wrapped in the resulting x509 certificate. In case of GP, the key used for signing is not verified by ROM, so usually a degenerate key is used. In case of HS-FS device, SYSFW will be encrypted with TI encryption key (TI MEK) and signed with TI asymmetric key (TI MPK). The SDK will contain the encrypted and signed binary.</p>
<p> <style>div.image img[src="sysfw_hs_fs.png"]{width:40%}</style> </p><div class="image">
<img src="sysfw_hs_fs.png" alt=""/>
<div class="caption">
SYSFW in HS-FS device</div></div>
<h1><a class="anchor" id="autotoc_md321"></a>
NON-SBL Example Appimage Build</h1>
<p>In case of example applications other than SBL (hello_world, dpl_demo etc...) the same application image file (<code>*.appimage</code>) can be booted by SBL on HS-FS / GP device, nothing special to be done for HS-FS since there is no extra signing needed.</p>
<p>Note: Appimages would eventually need signing by x509Certificate in HS-FS. This change is yet to be implemented. Once this is done, the appimages would have different extensions for HS-FS image. <code>*.appimage</code> would now become <code>*.appimage.hs_fs</code></p>
<h1><a class="anchor" id="autotoc_md322"></a>
SBL Application Build</h1>
<p>In case of SBL applications (sbl_sd, sbl_ospi, sbl_null etc...) since SDK follows combined boot flow, SYSFW is packaged along with the sbl final image (<code>*.tiimage</code>). Since the SYSFW is different between GP and HS-FS, the sbl final image also will change. This is taken care through an additional keyword in the file extension, **'hs_fs'**. The <code>*.tiimage</code> would now become <code>*.hs_fs.tiimage</code> For example in the case of <code>sbl_ospi</code>, with release build profile, the final image in the case of GP device type would be</p>
<ul>
<li><code>sbl_ospi.release.tiimage</code></li>
</ul>
<p>In case of HS-FS device type, it would be</p>
<ul>
<li><code>sbl_ospi.release.hs_fs.tiimage</code></li>
</ul>
<p>HS-FS images will be automatically built when you build SBLs, so no extra build options are required to be passed.</p>
<h1><a class="anchor" id="SBL_BOOT_HS_FS"></a>
Application boot using SBL (SBL OSPI, SBL NULL, SBL UART, SBL SD etc.)</h1>
<p>Since most of the differences in HS-FS is related to image signing, once the SBL and application image is correctly built, rest of the flow is the same as GP for application boot. Take care that the right images are used. For example, to use SBL NULL for your application boot, <b>flash the <code>sbl_null.release.hs_fs.tiimage</code></b> image. Same goes for other SBLs.</p>
<dl class="section attention"><dt>Attention</dt><dd>Please make sure that you use the SBL images with the <code>*.hs_fs.tiimage</code> and application images <code>*.appimage.hs_fs</code> extension while flashing.</dd></dl>
<h1><a class="anchor" id="CCS_BOOT_HS_FS"></a>
Application boot using CCS + GELs</h1>
<p>This section refers to the flow where users do not use any SBL, instead uses CCS + GELs and load_dmsc_hsfs.js to initialize SoC, load the DMSC M3 and manually load user application to desired core.</p>
<ul>
<li>M3 JTAG is locked, so can't connect to M3 and run GELs</li>
</ul>
<p>Steps to do DMSC initialization from CCS</p>
<ul>
<li>Set the board in DEV-BOOT mode (mandatory)</li>
<li>Power ON the EVM/board</li>
<li>Launch the CCS target configuration file</li>
<li>Run the load_dmsc_hs_fs.js script from the scripting console</li>
</ul>
<p>Since it can't connect to M3, it connects to R5. Now it runs an application (<code>sciclient_ccs_init</code>). The <code>sciclient_ccs_init</code> application will load load M3 with SYSFW and set the boardcfg and initialize the other cores.</p>
<p>The major difference here is the strict adherence of the boot mode to DEV-BOOT mode. This is necessary to be able to connect to the R5 and load the sciclient_ccs_init application. The DEV BOOT mode looks like below:</p>
<p> <style>div.image img[src="boot_pins_devboot_mode.png"]{width:40%}</style> </p><div class="image">
<img src="boot_pins_devboot_mode.png" alt=""/>
<div class="caption">
DEV BOOT MODE</div></div>
<p>To reiterate, to do application boot using CCS and GELs in HS-FS device</p>
<ul>
<li>Set the board in DEV-BOOT mode (mandatory)</li>
<li>Power ON the EVM/board</li>
<li>Launch the CCS target configuration file</li>
<li>Run the load_dmsc_hs_fs.js script from the scripting console</li>
<li>Wait for the SYSFW version to be printed on CCS console</li>
<li>Manually reset the R5FSS0_0 core and proceed towards application load</li>
</ul>
<h1><a class="anchor" id="autotoc_md323"></a>
Difference of SYSFW loading in SBL mode and CCS mode in HS-FS</h1>
<p>In the SBL based flow, the SBL image will contain the SYSFW in the appropriate format and the ROM will load the SBL and SYSFW. In this scenario, the above mentioned sysfw-hs-fs-enc.bin and sysfw-hs-fs-enc-cert.bin binaries would be used in the image creation. In case of CCS based flow, the loading is done in a different way using an R5 application. Here we have to use a binary concatenation of the certificate and the encrypted image and generate a hex header out of it. This hex header is then included by the R5 application and then loaded. This is already done and the header file is kept at the same location as other SYSFW binaries - <code><a class="el" href="sysfw__hs__fs__signed_8h.html">sysfw_hs_fs_signed.h</a></code></p>
<h1><a class="anchor" id="autotoc_md324"></a>
Firewall Configurations</h1>
<p>Since HS-FS devices has some the secure services, the firewall configurations are somewhat different compared to the fully open and non-secure GP devices. For example some of the SoC memory regions are firewalled in HS-FS devices. This includes the MSRAM, which cores or DMA engines might need to access. To tackle this, all the SBLs in the SDK opens the MSRAM firewalls right after SYSFW boot notification comes up. If you write your own bootloader, you should also do this. The API <code>Bootloader_socOpenFirewalls</code> can be used for this. For example usage, please check the source of any SBL.</p>
<h1><a class="anchor" id="autotoc_md325"></a>
Summary of differences in GP vs HS-FS</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Entity  </th><th class="markdownTableHeadNone">GP  </th><th class="markdownTableHeadNone">HS-FS   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SYSFW image  </td><td class="markdownTableBodyNone">Plain (<code>sysfw.bin</code>)  </td><td class="markdownTableBodyNone">Signed and encrypted with TI Key (<code>sysfw-hs-fs-enc.bin</code>, <code>sysfw-hs-fs-enc-cert.bin</code>)   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Application image name  </td><td class="markdownTableBodyNone"><code>*.appimage</code>  </td><td class="markdownTableBodyNone"><code>*.appimage.hs_fs</code> (eventually)   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SBL image name  </td><td class="markdownTableBodyNone"><code>*.tiimage</code>  </td><td class="markdownTableBodyNone"><code>*.hs_fs.tiimage</code>   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">CCS + GEL flow bootmode  </td><td class="markdownTableBodyNone">NO-BOOT recommended, any bootmode functional  </td><td class="markdownTableBodyNone">DEV-BOOT mode mandatory   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CCS + GEL flow js script  </td><td class="markdownTableBodyNone"><code>load_dmsc.js</code>  </td><td class="markdownTableBodyNone"><code>load_dmsc_hs_fs.js</code>   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Firewall Configurations  </td><td class="markdownTableBodyNone">Firewalls Open  </td><td class="markdownTableBodyNone">Some regions are firewalled   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md326"></a>
Signing of Images in GP vs HS-FS</h1>
<p>SBL images and non-SBL example application images use different signing scripts. This is due to the difference in the x509 certificate format expected by ROM and SYSFW. These differences and scripting is already part of SDK makefiles, but in case if the user has their own build system and wants to integrate these steps into it, please go through this section. The signing scripts used are python3 based.</p>
<h2><a class="anchor" id="autotoc_md327"></a>
SYSFW Signing</h2>
<p>SYSFW is not signed with SDK signing scripts. Pre-encrypted SYSFW binaries with x509 certificate binary generated as a result of signing with the TI keys is part of the SDK.</p>
<h2><a class="anchor" id="autotoc_md328"></a>
SBL Signing</h2>
<p>To create the x509 certificate header-ed SBL image, the script used is <code>rom_image_gen.py</code>. This is located in <code>${SDK_ROOT}/tools/boot/signing</code>. The usage of the script will be printed if you run it with <code>-h</code> option like so:</p>
<div class="fragment"><div class="line">$ python3 rom_image_gen.py -h</div>
<div class="line">usage: rom_image_gen.py [-h] [--swrv SWRV] --sbl-bin SBL_BIN [--sbl-enc] [--enc-key ENC_KEY] --sysfw-bin</div>
<div class="line">                        SYSFW_BIN [--sysfw-inner-cert SYSFW_INNER_CERT] --boardcfg-blob BOARDCFG_BLOB</div>
<div class="line">                        --sbl-loadaddr SBL_LOADADDR --sysfw-loadaddr SYSFW_LOADADDR --bcfg-loadaddr</div>
<div class="line">                        BCFG_LOADADDR --key KEY --rom-image ROM_IMAGE [--debug DEBUG]</div>
<div class="line"> </div>
<div class="line">Creates a ROM-boot-able combined image when the SBL, SYSFW and BoardCfg data are provided</div>
<div class="line"> </div>
<div class="line">optional arguments:</div>
<div class="line">  -h, --help            show this help message and exit</div>
<div class="line">  --swrv SWRV           Software revision number</div>
<div class="line">  --sbl-bin SBL_BIN     Path to the SBL binary</div>
<div class="line">  --sbl-enc             Encrypt SBL or not</div>
<div class="line">  --enc-key ENC_KEY     Path to the SBL Encryption Key</div>
<div class="line">  --sysfw-bin SYSFW_BIN</div>
<div class="line">                        Path to the sysfw binary</div>
<div class="line">  --sysfw-inner-cert SYSFW_INNER_CERT</div>
<div class="line">                        Path to the sysfw inner certificate</div>
<div class="line">  --boardcfg-blob BOARDCFG_BLOB</div>
<div class="line">                        Path to the boardcfg blob</div>
<div class="line">  --sbl-loadaddr SBL_LOADADDR</div>
<div class="line">                        Load address at which SBL needs to be loaded</div>
<div class="line">  --sysfw-loadaddr SYSFW_LOADADDR</div>
<div class="line">                        Load address at which SYSFW needs to be loaded</div>
<div class="line">  --bcfg-loadaddr BCFG_LOADADDR</div>
<div class="line">                        Load address at which BOARDCFG needs to be loaded</div>
<div class="line">  --key KEY             Path to the signing key to be used while creating the certificate</div>
<div class="line">  --rom-image ROM_IMAGE</div>
<div class="line">                        Output file combined ROM image of SBL+SYSFW+Boardcfg</div>
<div class="line">  --debug DEBUG         Debug options for the image</div>
</div><!-- fragment --><p>The script is usually run after the sbl binary is created using an objcopy utility. That is a <code>*.bin</code> file. In GP, we sign the binary using a degenerate key. We also pass the GP SYSFW binary and the boardcfg binary to the signing script. Here is an example of how it's done in GP for say <code>sbl_ospi</code>.</p>
<div class="fragment"><div class="line">$ python3 rom_image_gen.py --swrv 1 --sbl-bin /path/to/sbl_ospi.release.bin --sysfw-bin /path/to/sysfw.bin --boardcfg-blob /path/to/boardcfg_blob.bin --sbl-loadaddr 0x70000000 --sysfw-loadaddr 0x44000 --bcfg-loadaddr 0x7B000 --key /path/to/rom_degenerateKey.pem --rom-image /path/to/sbl_ospi.release.tiimage</div>
</div><!-- fragment --><p>In the options mentioned here, the values used for SYSFW load address (<code>--sysfw-loadaddr</code>) and BoardCfg load address (<code>--bcfg-loadaddr</code>) are fixed for an SoC, so no need to change. For SBL load address, we generally keep the top part of the MSRAM reserved for loading the SBL in the SDK. So we give the start of MSRAM, <code>0x70000000</code>. If your SBL needs to be loaded elsewhere, this value can be changed. Notice how just the SYSFW binary is passed in case of GP. This is an <b>unsigned, unencrypted binary</b>.</p>
<p>In case of HS-FS device, we use the same signing script, but there is a small difference in the usage.</p>
<div class="fragment"><div class="line">$ python3 rom_image_gen.py --swrv 1 --sbl-bin /path/to/sbl_ospi.release.bin --sysfw-bin /path/to/sysfw-hs-fs-enc.bin --sysfw-inner-cert /path/to/sysfw-hs-fs-enc-cert.bin--boardcfg-blob /path/to/boardcfg_blob.bin --sbl-loadaddr 0x70000000 --sysfw-loadaddr 0x44000 --bcfg-loadaddr 0x7B000 --key /path/to/rom_degenerateKey.pem --rom-image /path/to/sbl_ospi.release.hs_fs.tiimage</div>
</div><!-- fragment --><p>You can see that we are involving the x509 certificate for the HS-FS SYSFW binary in the image creation. This is the major difference in the SBL image creation of HS-FS devices. You would observe that the other parameters are pretty much the same between both cases.</p>
<h1><a class="anchor" id="autotoc_md329"></a>
Appimage Signing</h1>
<p>Signing for the application image is new in HS-FS compared to GP. For the signing of application images we use a different script. This is because authentication of application images are done by SYSFW and it expects a different x509 certificate format. For signing application images, the script used in <code>appimage_x509_cert_gen.py</code> located at <code>${SDK_ROOT}/source/security/security_common/tools/boot/signing/</code>. The usage of the script will be printed if you run it with <code>-h</code> option like so:</p>
<div class="fragment"><div class="line">python3 appimage_x509_cert_gen.py -h</div>
<div class="line">usage: appimage_x509_cert_gen.py [-h] [--bin BIN] [--key KEY] [--enckey ENCKEY] [--cert CERT] [--output OUTPUT] [--core CORE] [--enc ENC] [--loadaddr LOADADDR] [--authtype AUTHTYPE]</div>
<div class="line"> </div>
<div class="line">Generates a x509 certificate for an application binary to boot it in HS device</div>
<div class="line"> </div>
<div class="line">optional arguments:</div>
<div class="line">  -h, --help           show this help message and exit</div>
<div class="line">  --bin BIN            Bin file that needs to be signed</div>
<div class="line">  --key KEY            File with signing key inside it</div>
<div class="line">  --enckey ENCKEY      File with encryption key inside it</div>
<div class="line">  --cert CERT          Certificate file name (optional, will use a default name otherwise)</div>
<div class="line">  --output OUTPUT      Output file name (concatenated cert+bin)</div>
<div class="line">  --core CORE          Core on which the binary is meant to be loaded. Optional</div>
<div class="line">  --enc ENC            If the binary need to be encrypted or not [y/n]</div>
<div class="line">  --loadaddr LOADADDR  Target load address of the binary in hex. Default to 0x70000000</div>
<div class="line">  --authtype AUTHTYPE  Authentication type. [0/1/2]. 0 - Move to destination address specified after authentication, 1 - In place authentication, 2 - Move to the certificate start after authentication. Default is 1</div>
</div><!-- fragment --><p>Usage of the signing script in HS-FS is fairly simple compared to the SBL signing script. Here is a typical usage for <code>hello_world</code> example:</p>
<div class="fragment"><div class="line">$ python3 appimage_x509_cert_gen.py --bin /path/to/hello_world.release.appimage --authtype 1 --key /path/to/rom_degenerateKey.pem --output /path/to/hello_world.release.appimage.hs_fs</div>
</div><!-- fragment --><p>Note that the key used for signing is rom degenerate. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
