<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: Bootflow Migration Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM64x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">10.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('BOOTFLOW_MIGRATION_GUIDE.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Bootflow Migration Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_migration_guides_bootflow_migration_guide"></a> Some bootflow changes have been introduced in MCU+SDK, this document aims to explain the changes and is majorly meant for users of older SDK wanting to upgrade to the new flow.</p>
<h1><a class="anchor" id="autotoc_md330"></a>
Change Summary</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Normal Bootflow(OLD)  </th><th class="markdownTableHeadNone">Combined Bootflow(NEW)   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1. Power On Reset  </td><td class="markdownTableBodyNone">1. Power On Reset   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">2. ROM Bootloader (RBL) loads Secondary Bootloader (SBL)  </td><td class="markdownTableBodyNone">2. ROM Bootloader (RBL) loads SBL, SYSFW, and boardcfg together as one binary blob   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">3. SBL loads SYSFW, and sets boardcfg  </td><td class="markdownTableBodyNone">3. SBL waits for SYSFW to boot up   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">4. SBL loads application image(s)  </td><td class="markdownTableBodyNone">4. SBL loads application image(s)   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md331"></a>
Change Details</h1>
<ul>
<li>To understand what changed in the new combined boot flow, let's revisit the old (legacy) bootflow once:</li>
</ul>
<p> <style>div.image img[src="normalflow.png"]{ width:30%}</style> </p><div class="image">
<img src="normalflow.png" alt=""/>
<div class="caption">
Normal (Legacy) Boot Flow</div></div>
<ul>
<li>As it is shown in the above image, in the normal flow the RBL loads the SBL which then loads the SYSFW and sets boardcfg. To do this, the SBL needs to have the SYSFW and boardcfg data as hex arrays included in the SBL application source. The actual loading to the Cortex M3 core would be done by the DMSC ROM running in M3, and the SBL will just pass a pointer to the SYSFW array. There is an Sciclient API, <code>Sciclient_loadFirmware</code> used for this purpose. We created a wrapper API which calls this API, <code>Bootloader_socLoadSysfw</code>. It can be seen that this API is pretty much the first one to be invoked in the <code>main()</code> of the SBL. This API will also set the boardcfg, by calling the appropriate Sciclient APIs.</li>
<li>While this approach is simplistic, it comes with it's challenges. First of all, size of SYSFW is about 220 KB. This has to be placed in <code>.rodata</code> section when building the SBL application. This is wasted memory and will add to the size of SBL final image.</li>
<li>In addition to this, in supporting secure devices, SYSFW would be different. So for booting in secure devices the SBLs and bootloader library will have to be re-built to include the new C array with different firmware.</li>
<li>The solution to these issues is combined boot flow, in which ROM will load the SYSFW and boardcfg data instead of SBL. In this flow, we don't need to include the SYSFW or boardcfg in the SBL application, hence saving almost 220 KB of memory which</li>
</ul>
<p>can be used by applications. Also since the SYSFW and boardcfg data is not part of the build flow, the same libraries and SBLs can be used for secure/non-secure devices. Given below is a similar flow diagram for combined boot flow.</p>
<p> <style>div.image img[src="combinedflow.png"]{ width:30%}</style> </p><div class="image">
<img src="combinedflow.png" alt=""/>
<div class="caption">
Combined Boot Flow</div></div>
<h1><a class="anchor" id="autotoc_md332"></a>
Compatibility Breaks To Look-out For</h1>
<ul>
<li>For someone using the SBLs provided in the SDK as is, this update shouldn't change anything. But for ones who have written their own SBLs following the flow which we have provided, there might be some compatibility breaks</li>
</ul>
<ol type="1">
<li><code>Bootloader_socLoadSysFw</code> <b>API missing</b> : Since SBL no longer needs to load SYSFW, the <code>Bootloader_socLoadSysFw()</code> was removed to decrease the library size.</li>
<li><b>Signing Process</b> : Old (Legacy) Boot Flow and New (Combined) Boot Flow is recognized by ROM by virtue of the format of the x509 Certificate appended to the SBL. In old (legacy) boot flow, the SBL image to be booted by ROM was created using <code>x509Certificate.sh/x509Certificate.ps1</code> scripts under <code>tools/boot/signing</code> in the SDK. This script generates an x509 certificate for the SBL binary and append it to the SBL binary to create the final <code>*.tiimage</code> file. This signing and certificate appendment is required for ROM boot.</li>
</ol>
<p>In combined boot flow, we use a new script, <code>rom_image_gen.py</code> to generate the final <code>*.tiimage</code> which will be booted by the ROM.</p>
<p>If you are someone who doesn't use the SDK build system, you can take a look at the makefiles of any SBL examples to understand the usage of <code>rom_image_gen.py</code> script and take this into your build system as well.</p>
<p>Usage print of <code>rom_image_gen.py</code> is as follows:</p>
<div class="fragment"><div class="line">usage: rom_image_gen.py [-h] [--swrv SWRV] --sbl-bin SBL_BIN [--sbl-enc] [--enc-key ENC_KEY] --sysfw-bin SYSFW_BIN [--sysfw-inner-cert SYSFW_INNER_CERT] --boardcfg-blob BOARDCFG_BLOB --sbl-loadaddr SBL_LOADADDR --sysfw-loadaddr SYSFW_LOADADDR --bcfg-loadaddr BCFG_LOADADDR --key KEY --rom-image ROM_IMAGE [--debug DEBUG]</div>
</div><!-- fragment --><p>As you can see, the SBL binary and SYSFW binary among other things are <b>combined</b> together to form the final image as opposed to <code>x509Certificate.sh/ps1</code> script generating x509 certificate for SBL alone. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
