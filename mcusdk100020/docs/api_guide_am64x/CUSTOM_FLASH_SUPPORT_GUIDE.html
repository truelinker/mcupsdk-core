<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: Adding Support For a Custom Flash Device</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM64x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">10.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('CUSTOM_FLASH_SUPPORT_GUIDE.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Adding Support For a Custom Flash Device </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md254">Introduction</a><ul><li class="level2"><a href="#autotoc_md255">Serial Flash Discoverable Parameters (SFDP)</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md256">Summary of steps needed to enable a new flash device</a></li>
<li class="level1"><a href="#autotoc_md257">Step 1: Building the OSPI Flash Diagnostic example</a></li>
<li class="level1"><a href="#autotoc_md258">Step 2: Configuring the flash via SysConfig</a><ul><li class="level2"><a href="#autotoc_md259">Case 1: Flash Supports SFDP</a></li>
<li class="level2"><a href="#autotoc_md260">Case 2: Flash Doesn&#39;t Support SFDP</a></li>
<li class="level2"><a href="#autotoc_md261">Case 3 (Rare Scenario): Flash Supports SFDP, but Protocol Configuration is Custom</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md262">Obtaining flash details from the SFDP table OR datasheet</a></li>
<li class="level1"><a href="#autotoc_md263">Miscellaneous Debugging Tips and Tricks</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_developer_guides_custom_flash"></a></p>
<h1><a class="anchor" id="autotoc_md254"></a>
Introduction</h1>
<p>The flash driver in the SDK is supposed to work based on a configuration structure passed on the driver during the initialization time. This configuration structure has been chosen to support the configuration models of a number of flashes from multiple vendors. Currently, this configuration is generated by SysConfig from the options provided in the SysConfig Flash Module. This guide details the steps to bring up a custom flash using these tools and methods provided in the SDK. In a later version a method will be provided to do this without SysConfig as well.</p>
<p>The configuration structure can be obtained albeit automatically if the flash supports SFDP (Serial Flash Discoverable Parameter) table.</p>
<h2><a class="anchor" id="autotoc_md255"></a>
Serial Flash Discoverable Parameters (SFDP)</h2>
<p>The Serial Flash Discoverable Parameters (SFDP) is a standard which provides a consistent method of describing the functional and feature capabilities of the flash device in a standard set of internal parameter tables. This table can be queried to identify the configurations and adjustments needed to set the flash in a desired state.</p>
<p>The parsing of the SFDP table is time consuming. Considering this, the SFDP parsing feature in this SDK is tied with a diagnostic example of the OSPI driver. In flashes where the SFDP is supported, this example can be used to parse the details into a config structure which can aid bringing up the custom flash. As of now the SFDP parsing in the SDK supports upto JEDS216D standard.</p>
<h1><a class="anchor" id="autotoc_md256"></a>
Summary of steps needed to enable a new flash device</h1>
<ul>
<li><b>Step 1</b>: Build the <code>ospi_flash_diag</code> example : <a class="el" href="EXAMPLES_DRIVERS_OSPI_FLASH_DIAG.html">OSPI Flash Diagnostic</a>. This example communicates with the flash in 1S-1S-1S mode and queries the flash for the SFDP table (if SFDP is supported by the flash) among other things. The logs from this example would be required later to configure the flash driver.</li>
<li><b>Step 2</b>: Open the SysConfig GUI for the example/application you want to try with your flash and enter the details manually using the flash datasheet or using the JSON from <code>ospi_flash_diag</code> log. Save this SysConfig configuration.</li>
</ul>
<p>Now you can test your example/application with the new flash device! Also test the configuration with OSPI bootloader <a class="el" href="EXAMPLES_DRIVERS_SBL_OSPI.html">SBL OSPI</a> and flash writer <a class="el" href="EXAMPLES_DRIVERS_SBL_UART_UNIFLASH.html">SBL UART Flash Writer</a> by flashing an example <a class="el" href="GETTING_STARTED_FLASH.html">Flash a Hello World example</a>. Let's get into the details of the steps.</p>
<h1><a class="anchor" id="autotoc_md257"></a>
Step 1: Building the OSPI Flash Diagnostic example</h1>
<p>Refer the example page <a class="el" href="EXAMPLES_DRIVERS_OSPI_FLASH_DIAG.html">OSPI Flash Diagnostic</a> on building this application. You will need have to initialize the SOC in no boot mode as mentioned in <a class="el" href="EVM_SETUP_PAGE.html#EVM_SOC_INIT_NOBOOT_MODE">SOC Initialization Using CCS Scripting</a> and also load and run this example using CCS, as mentioned in <a class="el" href="CCS_LAUNCH_PAGE.html">CCS Launch, Load and Run</a>. Building and running the OSPI Flash Diagnostic example is important because regardless of flash supporting SFDP or not, the diagnostic example gives a basic sanity for the flash. If the flash diagnostic doesn't work, there could be HW connection issues most probably. When you successfully build and run the example, you should get a log something like this:</p>
<div class="fragment"><div class="line">[OSPI Flash Diagnostic Test] Starting ...</div>
<div class="line">[OSPI Flash Diagnostic Test] Flash Manufacturer ID : 0x34</div>
<div class="line">[OSPI Flash Diagnostic Test] Flash Device ID       : 0x5B1A</div>
<div class="line">[OSPI Flash Diagnostic Test] Executing Flash Erase on first block...</div>
<div class="line">[OSPI Flash Diagnostic Test] Done !!!</div>
<div class="line">[OSPI Flash Diagnostic Test] Performing Write-Read Test...</div>
<div class="line">[OSPI Flash Diagnostic Test] Write-Read Test Passed!</div>
<div class="line">[QSPI Flash Diagnostic Test] SFDP Information :</div>
<div class="line">================================================</div>
<div class="line">                      SFDP</div>
<div class="line">================================================</div>
<div class="line">SFDP Major Revision                       : 0x1</div>
<div class="line">SFDP Minor Revision                       : 0x8</div>
<div class="line">Number of Parameter Headers in this Table : 6</div>
<div class="line"> </div>
<div class="line">Types of Additional Parameter Tables in this flash</div>
<div class="line">---------------------------------------------------</div>
<div class="line">4 BYTE ADDRESSING MODE INSTRUCTIONS TABLE</div>
<div class="line">NOR SPI PROFILE TABLE</div>
<div class="line">STATUS CONTROL AND CONFIGURATION REGISTER MAP TABLE</div>
<div class="line">OCTAL DDR MODE COMMAND SEQUENCE TABLE</div>
<div class="line">SECTOR MAP TABLE</div>
<div class="line"> </div>
<div class="line">Parsing of OCTAL DDR MODE COMMAND SEQUENCE TABLE table not yet supported.</div>
<div class="line">JSON Data for the flash :</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">    &quot;flashSize&quot;: 67108864,</div>
<div class="line">    &quot;flashPageSize&quot;: 256,</div>
<div class="line">    &quot;flashManfId&quot;: &quot;0x34&quot;,</div>
<div class="line">    &quot;flashDeviceId&quot;: &quot;0x5B1A&quot;,</div>
<div class="line">    &quot;flashBlockSize&quot;: 262144,</div>
<div class="line">    &quot;flashSectorSize&quot;: 4096,</div>
<div class="line">    &quot;cmdBlockErase3B&quot;: &quot;0xDC&quot;,</div>
<div class="line">    &quot;cmdBlockErase4B&quot;: &quot;0xDC&quot;,</div>
<div class="line">    &quot;cmdSectorErase3B&quot;: &quot;0x21&quot;,</div>
<div class="line">    &quot;cmdSectorErase4B&quot;: &quot;0x21&quot;,</div>
<div class="line">    &quot;protos&quot;: {</div>
<div class="line">            &quot;p111&quot;: {</div>
<div class="line">                    &quot;isDtr&quot;: false,</div>
<div class="line">                    &quot;cmdRd&quot;: &quot;0x03&quot;,</div>
<div class="line">                    &quot;cmdWr&quot;: &quot;0x02&quot;,</div>
<div class="line">                    &quot;modeClksCmd&quot;: 0,</div>
<div class="line">                    &quot;modeClksRd&quot;: 0,</div>
<div class="line">                    &quot;dummyClksCmd&quot;: 0,</div>
<div class="line">                    &quot;dummyClksRd&quot;: 0,</div>
<div class="line">                    &quot;enableType&quot;: &quot;0&quot;,</div>
<div class="line">                    &quot;enableSeq&quot;: &quot;0x00&quot;,</div>
<div class="line">                    &quot;dummyCfg&quot;: null,</div>
<div class="line">                    &quot;protoCfg&quot;: null,</div>
<div class="line">                    &quot;strDtrCfg&quot;: null</div>
<div class="line">            },</div>
<div class="line">            &quot;p112&quot;: null,</div>
<div class="line">            &quot;p114&quot;: null,</div>
<div class="line">            &quot;p118&quot;: null,</div>
<div class="line">            &quot;p444s&quot;: null,</div>
<div class="line">            &quot;p444d&quot;: null,</div>
<div class="line">            &quot;p888s&quot;: null,</div>
<div class="line">            &quot;p888d&quot;: {</div>
<div class="line">                    &quot;isDtr&quot;: true,</div>
<div class="line">                    &quot;cmdRd&quot;: &quot;0xEE&quot;,</div>
<div class="line">                    &quot;cmdWr&quot;: &quot;0x12&quot;,</div>
<div class="line">                    &quot;modeClksCmd&quot;: 0,</div>
<div class="line">                    &quot;modeClksRd&quot;: 0,</div>
<div class="line">                    &quot;dummyClksCmd&quot;: 4,</div>
<div class="line">                    &quot;dummyClksRd&quot;: 24,</div>
<div class="line">                    &quot;enableType&quot;: &quot;0&quot;,</div>
<div class="line">                    &quot;enableSeq&quot;: &quot;0x00&quot;,</div>
<div class="line">                    &quot;dummyCfg&quot;: {</div>
<div class="line">                            &quot;isAddrReg&quot;: true,</div>
<div class="line">                            &quot;cmdRegRd&quot;:&quot;0x65&quot;,</div>
<div class="line">                            &quot;cmdRegWr&quot;:&quot;0x71&quot;,</div>
<div class="line">                            &quot;cfgReg&quot;:&quot;0x00800003&quot;,</div>
<div class="line">                            &quot;shift&quot;:0,</div>
<div class="line">                            &quot;mask&quot;:&quot;0x03&quot;,</div>
<div class="line">                            &quot;bitP&quot;:11</div>
<div class="line">                    },</div>
<div class="line">                    &quot;protoCfg&quot;: {</div>
<div class="line">                            &quot;isAddrReg&quot;: true,</div>
<div class="line">                            &quot;cmdRegRd&quot;: &quot;0x65&quot;,</div>
<div class="line">                            &quot;cmdRegWr&quot;: &quot;0x71&quot;,</div>
<div class="line">                            &quot;cfgReg&quot;: &quot;0x00800006&quot;,</div>
<div class="line">                            &quot;shift&quot;: 0,</div>
<div class="line">                            &quot;mask&quot;: &quot;0x00&quot;,</div>
<div class="line">                            &quot;bitP&quot;: 0</div>
<div class="line">                    },</div>
<div class="line">                    &quot;strDtrCfg&quot;: {</div>
<div class="line">                            &quot;isAddrReg&quot;: true,</div>
<div class="line">                            &quot;cmdRegRd&quot;: &quot;0x65&quot;,</div>
<div class="line">                            &quot;cmdRegWr&quot;: &quot;0x71&quot;,</div>
<div class="line">                            &quot;cfgReg&quot;: &quot;0x00800006&quot;,</div>
<div class="line">                            &quot;shift&quot;: 1,</div>
<div class="line">                            &quot;mask&quot;: &quot;0x00&quot;,</div>
<div class="line">                            &quot;bitP&quot;: 1</div>
<div class="line">                    }</div>
<div class="line">            },</div>
<div class="line">            &quot;pCustom&quot;: {</div>
<div class="line">                    &quot;fxn&quot;: null</div>
<div class="line">            }</div>
<div class="line">    },</div>
<div class="line">    &quot;addrByteSupport&quot;: &quot;1&quot;,</div>
<div class="line">    &quot;fourByteAddrEnSeq&quot;: &quot;0xA0&quot;,</div>
<div class="line">    &quot;cmdExtType&quot;: &quot;REPEAT&quot;,</div>
<div class="line">    &quot;resetType&quot;: &quot;0x10&quot;,</div>
<div class="line">    &quot;deviceBusyType&quot;: &quot;1&quot;,</div>
<div class="line">    &quot;cmdWren&quot;: &quot;0x06&quot;,</div>
<div class="line">    &quot;cmdRdsr&quot;: &quot;0x05&quot;,</div>
<div class="line">    &quot;srWip&quot;:  0,</div>
<div class="line">    &quot;srWel&quot;:  1,</div>
<div class="line">    &quot;cmdChipErase&quot;: &quot;0xC7&quot;,</div>
<div class="line">    &quot;rdIdSettings&quot;: {</div>
<div class="line">            &quot;cmd&quot;: &quot;0x9F&quot;,</div>
<div class="line">            &quot;numBytes&quot;: 5,</div>
<div class="line">            &quot;dummy4&quot;: 0,</div>
<div class="line">            &quot;dummy8&quot;: 0</div>
<div class="line">    },</div>
<div class="line">    &quot;xspiWipRdCmd&quot;: &quot;0x65&quot;,</div>
<div class="line">    &quot;xspiWipReg&quot;: &quot;0x00800000&quot;,</div>
<div class="line">    &quot;xspiWipBit&quot;: 0,</div>
<div class="line">    &quot;flashDeviceBusyTimeout&quot;: 256000000,</div>
<div class="line">    &quot;flashPageProgTimeout&quot;: 512</div>
<div class="line">}</div>
<div class="line">All tests have passed!!</div>
</div><!-- fragment --><p>You can see that the prints include the major and minor revisions of the SFDP standard supported. The diagnostic will print the SFDP details for this version only. As mentioned above, currently it supports till JESD216D version.</p>
<p>Between the lines <code>JSON Data for the flash</code> and <code>All tests have passed</code>, you can see the configuration data for the flash printed as a json. You will see this if your flash supports SFDP. In this case, copy this part save it as JSON file, this would be useful in Step 2. In fact, the TI Board Default Flash configuration is also saved as json.</p>
<h1><a class="anchor" id="autotoc_md258"></a>
Step 2: Configuring the flash via SysConfig</h1>
<p> <style>div.image img[src="flash_syscfg_gen.png"]{ width:30%}</style> </p><div class="image">
<img src="flash_syscfg_gen.png" alt=""/>
<div class="caption">
Flash SysConfig Module GUI</div></div>
<p>As you can see in the above image, there are various configurations options available for the flash.</p>
<ul>
<li>Start with setting the <code>Flash Device</code> as custom flash instead of TI Board Default Flash.</li>
<li>Enter the name of your flash part in the next configurable and select the protocol from the next drop down. If the required protocol is not supported, there is also an option to choose the data lines for CMD, ADDR and DATA sections of the flash datagram.</li>
</ul>
<p>Rest of the configuration depends on whether the flash supports SFDP or not.</p>
<h2><a class="anchor" id="autotoc_md259"></a>
Case 1: Flash Supports SFDP</h2>
<p>If your flash supports SFDP and the <code>ospi_flash_diag</code> example is able to print out the SFDP table as shown in Step 1, configuring the flash in your example via SysConfig is quite easy.</p>
<p> <style>div.image img[src="auto_cfg.png"]{ width:30%}</style> </p><div class="image">
<img src="auto_cfg.png" alt=""/>
<div class="caption">
Flash Auto Config</div></div>
<ul>
<li>To use the JSON file, scroll down to the section which says "Automatically Configure Flash". Now click on the <code>LOAD FROM JSON</code> button which will open a file dialog.</li>
<li>Browse to the JSON file saved in Step 1 and select it. SysConfig should "load" data from the file into the GUI.</li>
<li>You can cross verify the values with datasheet if required, but mostly this won't be necessary.</li>
</ul>
<h2><a class="anchor" id="autotoc_md260"></a>
Case 2: Flash Doesn't Support SFDP</h2>
<p>If your flash doesn't support SFDP, the flash configuration details would need to be filled in manually. This can be a pain point, but mostly flashes without SFDP support wouldn't have a lot of configuration as well. Only basic things like quad bit enable, etc would need to be looked up in the datasheet.</p>
<p>Most of the configurables should be self explanatory. Still if some terms seem confusing, look for a question mark icon near the configurable when you hover. Clicking on that should give the long description regarding a certain configurable.</p>
<p> <style>div.image img[src="long_desc.png"]{ width:30%}</style> </p><div class="image">
<img src="long_desc.png" alt=""/>
<div class="caption">
Long Description For Quad Enable Type</div></div>
<h2><a class="anchor" id="autotoc_md261"></a>
Case 3 (Rare Scenario): Flash Supports SFDP, but Protocol Configuration is Custom</h2>
<p>We have tried to keep an interface as generic as possible. But because of the variety of flash vendors and configurations, sometimes setting a protocol might differ from the sequences listed in SysConfig interface. Sometimes there might be extra steps required during the initialization for the flash to function correctly. To tackle this issue, we have given the option of two hooks:</p>
<ul>
<li>Custom Protocol Function</li>
<li>Quirks Function</li>
</ul>
<p>The custom protocol hook will be invoked in the middle of the Flash_open function and the quirks function will be invoked at the end of the Flash_open function.</p>
<p>You would find these options in the SysConfig GUI for flash under the protocol configuration after you've selected your protocol as __"Custom Protocol"__. The quirks function is always present as the last configurable.</p>
<p> <style>div.image img[src="quirks.png"]{ width:30%}</style> </p><div class="image">
<img src="quirks.png" alt=""/>
<div class="caption">
Custom Protocol and Quirks Function Hooks</div></div>
<p>You can leave these as <code>NULL</code> if your flash doesn't need this.</p>
<h1><a class="anchor" id="autotoc_md262"></a>
Obtaining flash details from the SFDP table OR datasheet</h1>
<p>This section can be ignored if the flash supports SFDP.</p>
<p>All the details regarding the flash including fast read opcodes, supported erase sizes, dummy clocks needed for each instruction and flash configuration registers information will be available from the flash data sheet.</p>
<ul>
<li>Flash size, page size and block size can be obtained from the introduction/overview section of the datasheet.</li>
<li>The read, write, register read, register write, read ID and other opcodes can be obtained from "Transaction tables". There will be transaction tables for each protocol (For example 1S-1S-1S transaction table, 8D-8D-8D transaction table)</li>
<li>The number of dummy cycles required for the read opcodes will also be available from the transaction table.</li>
<li>4 byte addressing mode will be supported in most flashes. Some of the legacy flashes which had &lt; 16 MB density might still use 3 byte addressing mode. Check the datasheet to see if 4 byte addressing mode is supported. There are multiple ways flash devices support 4 byte addressing mode. Sometimes there will be a configuration register which can be set so that flash switches to 4 byte addressing mode. In most cases, the flash will have separate set of opcodes for 4 byte addressing mode.</li>
<li>Configuration registers for setting various protocols, DTR clocking, and dummy cycles can be obtained from register configuration section/transaction tables.</li>
</ul>
<h1><a class="anchor" id="autotoc_md263"></a>
Miscellaneous Debugging Tips and Tricks</h1>
<ul>
<li>Device delay settings of the OSPI controller might need a change depending on the AC characteristics of the flash. The default value should work for most cases, but if there is a read issue especially at higher clock speeds and octal mode, this might be something to check for.</li>
<li>Sometimes if there is a data mismatch or data showing up with one-off bytes (usually in high speed octal transactions), it is advisable to check the dummy cycles, if the controller and flash are in agreement with the same. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
