<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: Enet CPSW EST Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM64x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">10.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLES_ENET_CPSW_EST.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Enet CPSW EST Example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md1244">Introduction</a></li>
<li class="level1"><a href="#autotoc_md1245">Configuration Parameters</a></li>
<li class="level1"><a href="#autotoc_md1246">Application Functionality</a><ul><li class="level2"><a href="#autotoc_md1247">EST Schedule</a></li>
<li class="level2"><a href="#autotoc_md1248">Transmit Test</a></li>
<li class="level2"><a href="#autotoc_md1249">EST Packet Timestamping</a></li>
<li class="level2"><a href="#autotoc_md1250">Other Test Options</a><ul><li class="level3"><a href="#autotoc_md1251">EST State Control</a></li>
<li class="level3"><a href="#autotoc_md1252">Additional EST Schedules</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md1253">Miscellaneous Options</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md1254">Application Flow</a></li>
<li class="level1"><a href="#autotoc_md1255">Supported Combinations</a></li>
<li class="level1"><a href="#autotoc_md1256">Steps to Run the Example</a><ul><li class="level2"><a href="#autotoc_md1257">Build the example</a></li>
<li class="level2"><a href="#autotoc_md1258">HW Setup</a><ul><li class="level3"><a href="#autotoc_md1259">AM263X-CC</a></li>
<li class="level3"><a href="#autotoc_md1260">AM263X-LP</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md1261">Run the example</a><ul><li class="level3"><a href="#autotoc_md1262">Basic Test</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md1263">Sample output</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md1264">See Also</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_examples_networking_enet_cpsw_est"></a></p>
<h1><a class="anchor" id="autotoc_md1244"></a>
Introduction</h1>
<p>This example application illustrates the configuration and usage of 802.1Qbv Enhanced Scheduled Traffic (EST) with CPSW through Enet LLD. The example application enables MAC port 1 by default, but it supports up to two MAC ports available in CPSW3G on SoC.</p>
<div class="image">
<img src="CpswEstExample_BlockDiagram.png" alt=""/>
<div class="caption">
CPSW EST example on device</div></div>
<p>The example application opens one DMA TX channel and one DMA RX channel. The TX channel will be used to inject test packets into CPSW host port. The RX channel receives packets and just drops them as this example doesn't focus on RX data path.</p>
<p>The application will also open the MAC port and will wait until the port gets link up with a remote partner (i.e. PC). The application then configures the same default EST schedule on the enabled MAC port.</p>
<p>The application uses <a class="el" href="group__ENET__MOD__TAS.html">Enet Time Aware Shaper</a> API for EST configuration and <a class="el" href="group__ENET__DMA__API.html">Enet Data Path (DMA)</a> API for packet transmission.</p>
<p>It's worth noting that this example application does not integrate time synchronization. This is relevant when both MAC ports are enabled and an external device (i.e. PC) is used to verify if the transmitted packets are meeting the programmed EST schedule (cycle time and time intervals), as CPSW CPTS internal clock might be off with respect to the external device's clock.</p>
<h1><a class="anchor" id="autotoc_md1245"></a>
Configuration Parameters</h1>
<p>Typically, the application's parameters that a developer may want to change are:</p>
<ul>
<li><b>Number of MAC ports</b>. By default the example application enables only MAC port 1, but the user can choose to enable MAC port 2 as well by setting <code>testParams.macPortNum = 1</code> in <code>enet_cpsw_est_main.c</code>. Some users may prefer to enable both MAC ports due to the flexibility to easily inject different kinds of test packets from the external ports, as opposed to just from the internal host port.</li>
<li><b>MAC port number</b>. When a single port is enabled, user can select the port number to test via <code>testParams.portTestParams[0].macPort</code> in <code>enet_cpsw_est_main.c</code>.</li>
<li><b>EST schedule</b>. User can set different EST schedule by setting a new cycle time in <code>testParams.portTestParams[0].tasControlList.cycleTime</code> and/or new gate control list in <code>testParams.portTestParams[n].tasControlList.gateCmdList</code> and <code>testParams.portTestParams[n].tasControlList.listLength</code>. Note that the EST schedule can be different for each MAC port.</li>
<li><b>CPTS event pool size</b>. User can increase the pool size to 32 or larger via <code>ENET_CFG_CPSW_CPTS_EVENTS_POOL_SIZE</code> in <a class="el" href="enet__cfg_8h.html" title="This file contains the Enet configuration parameters.">enet_cfg.h</a> if interested on verifying all timestamps generated for all TX test packets.</li>
</ul>
<h1><a class="anchor" id="autotoc_md1246"></a>
Application Functionality</h1>
<h2><a class="anchor" id="autotoc_md1247"></a>
EST Schedule</h2>
<p>The EST schedule programmed by this example application is shown below:</p>
<div class="image">
<img src="CpswEstExample_DfltSchedule.png" alt=""/>
<div class="caption">
Default EST schedule in CPSW EST example application</div></div>
<p>This EST schedule is 250 usecs long and is composed of 4 intervals, each with a gate mask that enables transmission of 2 priorities. There is no interval <em>stretching</em> or <em>truncation</em> in this sample schedule.</p>
<center> <table class="doxtable">
<caption>EST schedule parameters</caption>
<tr>
<th>Parameter </th><th>Time Value </th></tr>
<tr>
<td>BaseTime </td><td>Current time + <code>ENET_APP_EST_ADMIN_LIST_DELAY</code> </td></tr>
<tr>
<td>CycleTime </td><td>250 usecs </td></tr>
</table>
</center><center><table class="doxtable">
<caption>Gate control list</caption>
<tr>
<th>Gate Control </th><th>Time Interval </th></tr>
<tr>
<td><code>ooCCCCCC</code> </td><td>62.5 usecs </td></tr>
<tr>
<td><code>CCooCCCC</code> </td><td>62.5 usecs </td></tr>
<tr>
<td><code>CCCCooCC</code> </td><td>62.5 usecs </td></tr>
<tr>
<td><code>CCCCCCoo</code> </td><td>62.5 usecs </td></tr>
</table>
</center><p>Each of the 8 gates (one per priority) can be in one of two states:</p><ul>
<li><em>Open</em>: Frames in the corresponding queue can be selected for transmission. This is represented by '<code>o</code>' in the <em>Gate Control</em> column of previous table.</li>
<li><em>Closed</em>: Frames in the corresponding queue are not selected for transmission. This is represented by '<code>C</code>' in the <em>Gate Control</em> column.</li>
</ul>
<p>The <em>priority</em> being referred to in the EST schedule described above corresponds to the CPSW destination port hardware <em>switch priority</em>. For VLAN tagged packets that ingress through CPSW host port, the hardware switch priority can be determined by either the CPPI channel number (<code>P0_RX_REMAP_VLAN = 0</code>) or the packet priority value from the VLAN tag (<code>P0_RX_REMAP_VLAN = 1</code>).</p>
<p>For the sake of simplicity, this example configures CPSW to assign the <em>switch priority</em> from the VLAN tag priority in order to use a single TX channel. The relevant configuration parameters are shown in the code snippet below:</p>
<div class="fragment"><div class="line"><span class="comment">/* Hardware switch priority is taken from packet&#39;s PCP or DSCP */</span></div>
<div class="line">hostPortCfg-&gt;rxVlanRemapEn     = <span class="keyword">true</span>;</div>
<div class="line">hostPortCfg-&gt;rxDscpIPv4RemapEn = <span class="keyword">true</span>;</div>
<div class="line">hostPortCfg-&gt;rxDscpIPv6RemapEn = <span class="keyword">true</span>;</div>
</div><!-- fragment --><p>The IOCTLs used to program the EST schedule are:</p><ul>
<li><a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2aa50cd9fdb7cb503427624610d7b3db61">ENET_TAS_IOCTL_SET_STATE</a> to set the EST state to <em>RESET</em> (<a class="el" href="group__ENET__MOD__TAS.html#gga3acb36109645d538c493fd97c7dc817ca292753a3b16c05651371772a1de565a1">ENET_TAS_RESET</a>) before any other EST/TAS IOCTL. And subsequently, after the administrative list has been programmed, to set EST state to <em>ENABLE</em> (<a class="el" href="group__ENET__MOD__TAS.html#gga3acb36109645d538c493fd97c7dc817ca22dfbd3f27824d920781a1e80e760e23">ENET_TAS_ENABLE</a>).</li>
<li><a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2a2d555672c01e2a6720fd139936844561">ENET_TAS_IOCTL_SET_ADMIN_LIST</a> to program the default EST administrative control list. The administrative base time, cycle time and gate control list are passed via this IOCTL command.</li>
<li><a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2adf819fd64596c65886ac45fe7ce64fde">ENET_TAS_IOCTL_GET_OPER_LIST_STATUS</a> is called as many times as needed to check if the operational list has been updated.</li>
</ul>
<p>Additionally, the following <em>getter</em> IOCTLs are called for informational reasons:</p><ul>
<li><a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2a75729fd6cb6293708015c03b4dc968cd">ENET_TAS_IOCTL_GET_STATE</a> to get the current EST/TAS state.</li>
<li><a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2a792ce6f703556d008a381d336b10dd4a">ENET_TAS_IOCTL_GET_ADMIN_LIST</a> to get the driver's version of the administrative list after one has been programmed. The admin list is then printed to serial console.</li>
<li><a class="el" href="group__ENET__MOD__TAS.html#ggada0ad2c0a7a0c6530e49a3dd78c09ab2ac1c01d208f449eed17246c96cb2bcde1">ENET_TAS_IOCTL_GET_OPER_LIST</a> to get the driver's version of the operational list after one has been programmed. The oper list is then printed to serial console.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1248"></a>
Transmit Test</h2>
<p>The example application provides an option to send <code>ENETAPP_TEST_TX_PKT_CNT</code> (16) test packets through the single TX channel opened by the driver at initialization time.</p>
<p>Each test frame is a broadcast packet, 64 bytes long, VLAN tagged with VLAN Id 100 and PCP values from 0 through 7. The test packet content is shown below:</p>
<div class="fragment"><div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 0</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 1</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 2</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x02 0x02 0x02 0x02 0x02 0x02 0x02 0x02 0x02 0x02 0x02 0x02 0x02 0x02 0x02 ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 3</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x03 0x03 0x03 0x03 0x03 0x03 0x03 0x03 0x03 0x03 0x03 0x03 0x03 0x03 0x03 ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 4</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x04 0x04 0x04 0x04 0x04 0x04 0x04 0x04 0x04 0x04 0x04 0x04 0x04 0x04 0x04 ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 5</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x05 0x05 0x05 0x05 0x05 0x05 0x05 0x05 0x05 0x05 0x05 0x05 0x05 0x05 0x05 ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 6</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x06 0x06 0x06 0x06 0x06 0x06 0x06 0x06 0x06 0x06 0x06 0x06 0x06 0x06 0x06 ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 7</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x07 0x07 0x07 0x07 0x07 0x07 0x07 0x07 0x07 0x07 0x07 0x07 0x07 0x07 0x07 ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 0</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x08 0x08 0x08 0x08 0x08 0x08 0x08 0x08 0x08 0x08 0x08 0x08 0x08 0x08 0x08 ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 1</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x09 0x09 0x09 0x09 0x09 0x09 0x09 0x09 0x09 0x09 0x09 0x09 0x09 0x09 0x09 ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 2</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x0a 0x0a 0x0a 0x0a 0x0a 0x0a 0x0a 0x0a 0x0a 0x0a 0x0a 0x0a 0x0a 0x0a 0x0a ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 3</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x0b 0x0b 0x0b 0x0b 0x0b 0x0b 0x0b 0x0b 0x0b 0x0b 0x0b 0x0b 0x0b 0x0b 0x0b ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 4</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x0c 0x0c 0x0c 0x0c 0x0c 0x0c 0x0c 0x0c 0x0c 0x0c 0x0c 0x0c 0x0c 0x0c 0x0c ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 5</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x0d 0x0d 0x0d 0x0d 0x0d 0x0d 0x0d 0x0d 0x0d 0x0d 0x0d 0x0d 0x0d 0x0d 0x0d ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 6</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x0e 0x0e 0x0e 0x0e 0x0e 0x0e 0x0e 0x0e 0x0e 0x0e 0x0e 0x0e 0x0e 0x0e 0x0e ...</div>
<div class="line"> </div>
<div class="line">Dst addr : ff:ff:ff:ff:ff:ff</div>
<div class="line">Src addr : 70:ff:76:1d:ec:f2</div>
<div class="line">TPID     : 0x8100</div>
<div class="line">Priority : 7</div>
<div class="line">VLAN Id  : 100</div>
<div class="line">EtherType: 0x88b5</div>
<div class="line">Payload  : 0x0f 0x0f 0x0f 0x0f 0x0f 0x0f 0x0f 0x0f 0x0f 0x0f 0x0f 0x0f 0x0f 0x0f 0x0f ...</div>
</div><!-- fragment --><p>Packets are transmitted using regular Enet LLD's <a class="el" href="group__ENET__DMA__API.html#gac80790c3fbf88c40ce547c41c6164ae6">EnetDma_submitTxPktQ()</a> API.</p>
<h2><a class="anchor" id="autotoc_md1249"></a>
EST Packet Timestamping</h2>
<p>The example application configures the EST <em>administrative base time</em> to be equal to the current time + <code>ENET_APP_EST_ADMIN_LIST_DELAY</code> (100 msecs). This is useful to normalize the timestamps of the transmitted packets and verify that they are being sent on the appropriate time intervals.</p>
<p>When enabled via serial console menu (option '<code>t</code>'), CPSW ESTF will be configured to generate timestamps on every <em>express packet</em>. Each timestamp generates a CPTS interrupt which the Enet LLD driver services, the driver copies the timestamp event information into a software pool where the application can then retrieve. This CPTS event pool is shared among all MAC ports.</p>
<p>The timestamp option in this example application works together with option '<code>T</code>' which sents a short stream of test packets. At the end of the transmission, the application will retrieve the available timestamps and verify if they met the programmed EST schedule.</p>
<p>The pool size determines the maximum number of events that the driver can store until the application retrieves them. The default pool size is 8, but it's configurable via <code>ENET_CFG_CPSW_CPTS_EVENTS_POOL_SIZE</code> in <a class="el" href="enet__cfg_8h.html" title="This file contains the Enet configuration parameters.">enet_cfg.h</a>.</p>
<p>The relevant IOCTLs used by this application for EST timestamping are:</p><ul>
<li><a class="el" href="group__CPSW__MACPORT__MOD.html#gga9f78d0e84102d48a7c5097bd27620d6fab182235fcc76e2ab7328ff1de0ca10a6">CPSW_MACPORT_IOCTL_EST_ENABLE_TIMESTAMP</a> to enable timestamping on a given MAC port. Application can choose the type of timestamping mode (i.e. timestamp all transmitted packets, timestamp only first packet in each interval, etc.).</li>
<li><a class="el" href="group__CPSW__MACPORT__MOD.html#gga9f78d0e84102d48a7c5097bd27620d6faa68211d9809d6aa5fca41f07e3c3f97b">CPSW_MACPORT_IOCTL_EST_DISABLE_TIMESTAMP</a> to disable timestamping on a given MAC port.</li>
<li><a class="el" href="group__CPSW__CPTS__MOD.html#ggab788726fe114cfc32a32011edfa724ffac0a8dd0957cbe423b3b64dfea807c34d">CPSW_CPTS_IOCTL_LOOKUP_EST_EVENT</a> to retrieve timestamp events from the driver's internal event pool. The application must specify the MAC port for which the events must be looked up in the event pool.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1250"></a>
Other Test Options</h2>
<p>Additional test options are provided if the user wants to exercise the EST functionality beyond the basic usage described in earlier sections. The user can enter '<code>h</code>' at any time in the application's menu to display the test options.</p>
<h3><a class="anchor" id="autotoc_md1251"></a>
EST State Control</h3>
<p>The following options are provided by the application to change the EST state on all enabled MAC ports:</p>
<ul>
<li>Set EST state to <em>ENABLE</em>.</li>
<li>Set EST state to <em>DISABLE</em>.</li>
<li>Set EST state to <em>RESET</em>.</li>
</ul>
<h3><a class="anchor" id="autotoc_md1252"></a>
Additional EST Schedules</h3>
<p>In additional the default EST schedule, the example application also provides 9 different test schedules which the user can optionally try.</p>
<ol type="1">
<li>Administrative list with last time interval stretched to the end of the cycle.</li>
<li>Administrative list truncated due to cycle time shorter that total interval time.</li>
<li>Administrative list with <em>guard band</em>.</li>
<li>Administrative list with single priority enabled. Only packets with priority 7 will be transmitted.</li>
<li>Administrative list with base time in the future. This is not supported when EST is in <em>ENABLE</em> state, but it's supported when EST is in <em>DISABLE</em> or <em>RESET</em> states.</li>
<li>Administrative list with different cycle time. This is not supported when EST is in <em>ENABLE</em> state, but it's supported when EST is in <em>DISABLE</em> or <em>RESET</em> states.</li>
<li>Administrative list with time interval too small. Driver shall reject this EST schedule.</li>
<li>Administrative list with cycle time of zero. This is an invalid configuration and shall be rejected by the driver.</li>
<li>Administrative list with a zero interval followed by non-zero intervals. This is an invalid configuration and shall be rejected by the driver.</li>
</ol>
<h2><a class="anchor" id="autotoc_md1253"></a>
Miscellaneous Options</h2>
<p>The following helper options are also provided in the application's test menu:</p>
<ol type="1">
<li>Get current time.</li>
<li>Print network statistics.</li>
<li>Reset (clear) network statistics.</li>
<li>Stop the test.</li>
</ol>
<h1><a class="anchor" id="autotoc_md1254"></a>
Application Flow</h1>
<p>The most important steps related to the EST configuration performed by the application are shown in the following sequence diagram:</p>
<div class="image">
<img src="CpswEst_ExampleApp.png" alt=""/>
<div class="caption">
Application Flow</div></div>
<h1><a class="anchor" id="autotoc_md1255"></a>
Supported Combinations</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CPU + OS  </td><td class="markdownTableBodyNone">r5fss0-0_freertos   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Toolchain  </td><td class="markdownTableBodyNone">ti-arm-clang   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Boards  </td><td class="markdownTableBodyNone">am64x-evm   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Example folder  </td><td class="markdownTableBodyNone">examples/networking/enet_cpsw_est/V1   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md1256"></a>
Steps to Run the Example</h1>
<h2><a class="anchor" id="autotoc_md1257"></a>
Build the example</h2>
<ul>
<li>When using CCS projects to build, import the CCS project for the required combination and build it using the CCS project menu (see <a class="el" href="CCS_PROJECTS_PAGE.html">Using SDK with CCS Projects</a>).</li>
<li>When using makefiles to build, note the required combination and build using make command (see <a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
</ul>
<h2><a class="anchor" id="autotoc_md1258"></a>
HW Setup</h2>
<p>Make sure you have setup the EVM with cable connections as shown in <a class="el" href="EVM_SETUP_PAGE.html">EVM Setup</a>. In addition, follow the steps in the next section.</p>
<dl class="section note"><dt>Note</dt><dd>Ethernet cable must be connected and link must be up in order for the example application to continue execution.</dd></dl>
<h3><a class="anchor" id="autotoc_md1259"></a>
AM263X-CC</h3>
<ul>
<li>If using MAC port 1 (default), connect an Ethernet cable to the RJ-45 jack labeled as <code>J7</code>.</li>
<li>If using MAC port 2, connect an Ethernet cable to the RJ-45 jack labeled as <code>J4</code>.</li>
</ul>
<h3><a class="anchor" id="autotoc_md1260"></a>
AM263X-LP</h3>
<ul>
<li>If using MAC port 1 (default), connect an Ethernet cable to the RJ-45 jack labeled as <code>J7</code>.</li>
<li>If using MAC port 2, connect an Ethernet cable to the RJ-45 jack labeled as <code>J8</code>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1261"></a>
Run the example</h2>
<h3><a class="anchor" id="autotoc_md1262"></a>
Basic Test</h3>
<p>The simplest test that one can run with the CPSW EST example consists of:</p><ul>
<li>Enabling EST and programming a default EST schedule on the selected MAC port.</li>
<li>Sending test packets from example app with different priorities.</li>
<li>Verify that packets are transmitted within the time intervals corresponding to the packet priority.</li>
</ul>
<p>The steps to run this test are:</p>
<ul>
<li>Connect the MAC port as described in <b>HW Setup</b> section.</li>
<li>Optional: If using PC connected to the EVM port, open Wireshark in order to check the packets sent by the example application. Note that the timestamps in Wireshark are not necessarily accurate (see <a href="https://www.wireshark.org/docs/wsug_html/#_accuracy">Wireshark documentation</a>).</li>
<li>Launch a CCS debug session and run the example executable, see <a class="el" href="CCS_LAUNCH_PAGE.html">CCS Launch, Load and Run</a>.</li>
<li>Application logs such as cycle time, time intervals and gate masks will be printed in the serial console. Sample logs are shown in the next section.</li>
<li>Enable EST timestamping by entering '<code>t</code>' on the serial console.</li>
<li>Run TX test by entering '<code>T</code>' on the serial console. Test status will be printed in the serial console.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd><a class="el" href="structTimestamp.html" title="The Timestamp type represents a positive time with respect to the epoch.">Timestamp</a> check mechanism used to determined test status is enabled only with the default EST schedule. The timestamp check will be disabled automatically when EST is disabled (option <code>D</code> or <code>R</code> is entered, or when link is lost).</dd></dl>
<h2><a class="anchor" id="autotoc_md1263"></a>
Sample output</h2>
<div class="fragment"><div class="line">==========================</div>
<div class="line">       CPSW EST Test      </div>
<div class="line">==========================</div>
<div class="line">Open MAC port 1</div>
<div class="line">EnetPhy_bindDriver: PHY 0: OUI:080028 Model:0f Ver:01 &lt;-&gt; &#39;dp83869&#39; : OK</div>
<div class="line">Host MAC address: 70:ff:76:1d:ec:f2</div>
<div class="line">Port 1: Waiting for link up...</div>
<div class="line">Cpsw_handleLinkUp: Port 1: Link up: 1-Gbps Full-Duplex</div>
<div class="line">MAC Port 1: link up</div>
<div class="line">Port 1: Link is up</div>
<div class="line">MAC Port 1: suggested start time: 5012930968</div>
<div class="line"> </div>
<div class="line">MAC 1: Admin List</div>
<div class="line">-------------------------------------------</div>
<div class="line">Gate mask=ooCCCCCC (0xc0), start=0 ns, end=62499 ns, dur=62500 ns</div>
<div class="line">Gate mask=CCooCCCC (0x30), start=62500 ns, end=124999 ns, dur=62500 ns</div>
<div class="line">Gate mask=CCCCooCC (0x0c), start=125000 ns, end=187499 ns, dur=62500 ns</div>
<div class="line">Gate mask=CCCCCCoo (0x03), start=187500 ns, end=249999 ns, dur=62500 ns</div>
<div class="line">Cycle time=250000 ns</div>
<div class="line">Base time=5012930968 ns</div>
<div class="line"> </div>
<div class="line">MAC 1: Oper List</div>
<div class="line">-------------------------------------------</div>
<div class="line">Gate mask=ooCCCCCC (0xc0), start=0 ns, end=62503 ns, dur=62504 ns</div>
<div class="line">Gate mask=CCooCCCC (0x30), start=62504 ns, end=125007 ns, dur=62504 ns</div>
<div class="line">Gate mask=CCCCooCC (0x0c), start=125008 ns, end=187511 ns, dur=62504 ns</div>
<div class="line">Gate mask=CCCCCCoo (0x03), start=187512 ns, end=250015 ns, dur=62504 ns</div>
<div class="line">Cycle time=250000 ns</div>
<div class="line">Base time=5012930968 ns</div>
<div class="line">MAC addr: 70:ff:76:1d:ec:f2</div>
<div class="line"> </div>
<div class="line">CPSW EST Test Menu:</div>
<div class="line"> EST control list tests:</div>
<div class="line"> &#39;T&#39;  -  Send test packets from host port</div>
<div class="line"> &#39;1&#39;  -  Set admin list #1 (stretch)</div>
<div class="line"> &#39;2&#39;  -  Set admin list #2 (truncate)</div>
<div class="line"> &#39;3&#39;  -  Set admin list #3 (guard band)</div>
<div class="line"> &#39;4&#39;  -  Set admin list #4 (single priority)</div>
<div class="line"> &#39;5&#39;  -  Set admin list #5 (admin basetime in future)</div>
<div class="line"> &#39;6&#39;  -  Set admin list #6 (unsupported list - new cycle time)</div>
<div class="line"> &#39;7&#39;  -  Set admin list #7 (unsupported list - too small interval)</div>
<div class="line"> &#39;8&#39;  -  Set admin list #8 (invalid list - zero length)</div>
<div class="line"> &#39;9&#39;  -  Set admin list #9 (invalid list - zero interval)</div>
<div class="line"> EST state:</div>
<div class="line"> &#39;E&#39;  -  Set EST state to &#39;ENABLE&#39;</div>
<div class="line"> &#39;D&#39;  -  Set EST state to &#39;DISABLE&#39;</div>
<div class="line"> &#39;R&#39;  -  Set EST state to &#39;RESET&#39;</div>
<div class="line"> Others:</div>
<div class="line"> &#39;c&#39;  -  Get current time</div>
<div class="line"> &#39;t&#39;  -  Toggle printing timestamps</div>
<div class="line"> &#39;s&#39;  -  Print statistics</div>
<div class="line"> &#39;r&#39;  -  Reset statistics</div>
<div class="line"> &#39;x&#39;  -  Stop the test</div>
<div class="line"> &#39;h&#39;  -  Show this menu</div>
<div class="line"> </div>
<div class="line">t</div>
<div class="line"> </div>
<div class="line">Enable timestamp printing</div>
<div class="line">T</div>
<div class="line"> </div>
<div class="line">MAC 1: EST timestamp verification</div>
<div class="line">-------------------------------------------</div>
<div class="line">Programmed EST time intervals:</div>
<div class="line">Gate mask=ooCCCCCC (0xc0), start=0 ns, end=62503 ns</div>
<div class="line">Gate mask=CCooCCCC (0x30), start=62504 ns, end=125007 ns</div>
<div class="line">Gate mask=CCCCooCC (0x0c), start=125008 ns, end=187511 ns</div>
<div class="line">Gate mask=CCCCCCoo (0x03), start=187512 ns, end=250000 ns</div>
<div class="line"> </div>
<div class="line">Retrieved EST timestamps:</div>
<div class="line">Note: last 8 timestamps per port are stored with current CPTS pool size (8)</div>
<div class="line">MAC Port 1: packet with priority 3 timestamp 9359306373 (norm 125405) interval (125008, 187511) : PASS</div>
<div class="line">MAC Port 1: packet with priority 3 timestamp 9359307073 (norm 126105) interval (125008, 187511) : PASS</div>
<div class="line">MAC Port 1: packet with priority 2 timestamp 9359307778 (norm 126810) interval (125008, 187511) : PASS</div>
<div class="line">MAC Port 1: packet with priority 2 timestamp 9359308483 (norm 127515) interval (125008, 187511) : PASS</div>
<div class="line">MAC Port 1: packet with priority 1 timestamp 9359368873 (norm 187905) interval (187512, 250000) : PASS</div>
<div class="line">MAC Port 1: packet with priority 1 timestamp 9359369578 (norm 188610) interval (187512, 250000) : PASS</div>
<div class="line">MAC Port 1: packet with priority 0 timestamp 9359370283 (norm 189315) interval (187512, 250000) : PASS</div>
<div class="line">MAC Port 1: packet with priority 0 timestamp 9359370988 (norm 190020) interval (187512, 250000) : PASS</div>
</div><!-- fragment --><p><em>Note</em>: Although all packets are timestamped by CPTS, some timestamps will be overwritten in driver's event pool depending on the pool size. The timestamps that are printed in the serial terminal will vary as the packet transmission via option '<code>T</code>' happens asynchronously of the EST cycle.</p>
<h1><a class="anchor" id="autotoc_md1264"></a>
See Also</h1>
<p><a class="el" href="NETWORKING.html">Ethernet And Networking</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
