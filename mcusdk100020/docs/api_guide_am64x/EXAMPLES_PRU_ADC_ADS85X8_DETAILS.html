<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: ADS85x8 Implementation Details</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM64x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">10.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLES_PRU_ADC_ADS85X8_DETAILS.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ADS85x8 Implementation Details </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_examples_pru_io_ads85x8_details"></a> </p>
<h1><a class="anchor" id="autotoc_md1540"></a>
Implementation Details</h1>
<p>The control of ADC pins is divided between PRU and R5F cores as shown:</p>
<p> <style>div.image img[src="AM64x-ads85x8_interface.png"]{width:40%}</style> </p><div class="image">
<img src="AM64x-ads85x8_interface.png" alt=""/>
<div class="caption">
PRU ADS85x8 Setup</div></div>
<p>The current interfacing with ADS 85xx operates in following configuration:</p><ul>
<li>40kSPS sampling rate</li>
<li>Common ConvstA and ConvstB signals (Both pins connected together) (Convst = Conversion Start pin)</li>
<li>The CS line is kept low while reading data from all channels</li>
<li>The ADC data is read after the Convst signal goes low</li>
<li>First Data signal from ADC is not being used</li>
<li>Signal trace for the current implementation is shown in figure below (can check timing details from this)</li>
</ul>
<p> <style>div.image img[src="ads8598_timing_capture.png"]{width:80%}</style> </p><div class="image">
<img src="ads8598_timing_capture.png" alt=""/>
</div>
<h3><a class="anchor" id="autotoc_md1541"></a>
R5F Function:</h3>
<ul>
<li>Write PRU firmware instructions into IRAM of PRU</li>
<li>Initialize ADC and PRU</li>
<li>Send instructions to PRU core</li>
<li>Wait for interrupt from PRU indicating 1 block of adc samples has been received</li>
<li>On interrupt fetch the block id to read and read the samples</li>
<li>Process them as needed</li>
</ul>
<div class="fragment"><div class="line">ADC_init();</div>
<div class="line">ADC_powerUp();</div>
<div class="line">ADC_reset();</div>
<div class="line">ADC_startConversion();</div>
<div class="line"> </div>
<div class="line">/* Get ADC data from PRU */</div>
<div class="line">PRU_IPC_getData(gPruIpc0Handle, samples);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md1542"></a>
PRU Function:</h3>
<ul>
<li>Wait for commands from R5F and do accordingly While executing ADC interface section:</li>
<li>Wait for ADC Busy to go low indicating conversion has completed</li>
<li>Start reading samples from each ADC channel</li>
<li>Preprocess samples as required</li>
<li>Send samples to shared memory using ipc</li>
<li>Repeat above steps again</li>
</ul>
<div class="fragment"><div class="line">START:</div>
<div class="line">    ; Wait for Busy to go low indicating conversion has completed</div>
<div class="line">    m_wait_high_pulse       4, 16</div>
<div class="line">    ; Fetch and store channel 1-8 Sample</div>
<div class="line">    m_parallel_read_packet   ADC_COMM_MODE, ADC_COMM_INTERFACE, ADC_COMM_DATAWIDTH, ADC_COMM_TRIG_PRD, ADC_DATA_REG_1</div>
<div class="line">    m_parallel_read_packet   ADC_COMM_MODE, ADC_COMM_INTERFACE, ADC_COMM_DATAWIDTH, ADC_COMM_TRIG_PRD, ADC_DATA_REG_2</div>
<div class="line">    m_parallel_read_packet   ADC_COMM_MODE, ADC_COMM_INTERFACE, ADC_COMM_DATAWIDTH, ADC_COMM_TRIG_PRD, ADC_DATA_REG_3</div>
<div class="line">    m_parallel_read_packet   ADC_COMM_MODE, ADC_COMM_INTERFACE, ADC_COMM_DATAWIDTH, ADC_COMM_TRIG_PRD, ADC_DATA_REG_4</div>
<div class="line">    m_parallel_read_packet   ADC_COMM_MODE, ADC_COMM_INTERFACE, ADC_COMM_DATAWIDTH, ADC_COMM_TRIG_PRD, ADC_DATA_REG_5</div>
<div class="line">    m_parallel_read_packet   ADC_COMM_MODE, ADC_COMM_INTERFACE, ADC_COMM_DATAWIDTH, ADC_COMM_TRIG_PRD, ADC_DATA_REG_6</div>
<div class="line">    m_parallel_read_packet   ADC_COMM_MODE, ADC_COMM_INTERFACE, ADC_COMM_DATAWIDTH, ADC_COMM_TRIG_PRD, ADC_DATA_REG_7</div>
<div class="line">    m_parallel_read_packet   ADC_COMM_MODE, ADC_COMM_INTERFACE, ADC_COMM_DATAWIDTH, ADC_COMM_TRIG_PRD, ADC_DATA_REG_8</div>
<div class="line"> </div>
<div class="line">    ; Sign extend data to 32 bits</div>
<div class="line">    m_sign_ext_32bit    ADC_DATA_REG_1</div>
<div class="line">    m_sign_ext_32bit    ADC_DATA_REG_2</div>
<div class="line">    m_sign_ext_32bit    ADC_DATA_REG_3</div>
<div class="line">    m_sign_ext_32bit    ADC_DATA_REG_4</div>
<div class="line">    m_sign_ext_32bit    ADC_DATA_REG_5</div>
<div class="line">    m_sign_ext_32bit    ADC_DATA_REG_6</div>
<div class="line">    m_sign_ext_32bit    ADC_DATA_REG_7</div>
<div class="line">    m_sign_ext_32bit    ADC_DATA_REG_8</div>
<div class="line"> </div>
<div class="line">    ; Send samples to R5F</div>
<div class="line">    ldi        R1.b0, &amp;R2</div>
<div class="line">    m_pru_ipc_send  R1.b0, R2, R0.b0, PRU_IPC_RX_INTR_ENABLE, PRU_IPC_RX_EVENT</div>
<div class="line"> </div>
<div class="line">    ; Check if there is some instruction from R5F</div>
<div class="line">    m_prgm_flow_jump_on_intr    0x16, 31, 5, TEMP_REG_1, IDLE, task_manager, sample_transfer, iep, main_loop</div>
<div class="line"> </div>
<div class="line">    qba    START ; loop</div>
<div class="line">    halt</div>
</div><!-- fragment --><dl class="section user"><dt></dt><dd>Tips to Modify PRU Firmware:<ul>
<li>For driving the conversion start pins separately, first select separate conversion start from SyConfig to do automatic pinmux settings for that. Then you can check out the IEP code section in PRU to drive that pin by enabling that iep sync out signal.</li>
<li>To drive CS pin along with RD pin, check the <code>m_parallel_read_packet</code> macro implementation and add code for driving CS pin in that macro.</li>
<li>To use input from first data pin, check the <code>m_parallel_read_packet</code> macro implementation and add code for checking first data pin in that macro</li>
<li>The current firmware does sign extension of 18bits data to 32 bits data. For ADCs with resolution 16 bits, replace the macro <code>m_sign_ext_32bit</code> in <code>examples/pru_io/adc/ads85x8/firmware/main.asm</code> with <code>m_sign_ext_16to32_bits</code>.</li>
</ul>
</dd></dl>
<p>Refer to <a href="../pru_macros_docs/index.html">PRU Source Macros Documentation</a> for making changes to PRU firmware. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
