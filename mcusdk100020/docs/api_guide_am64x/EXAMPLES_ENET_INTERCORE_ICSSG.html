<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: Intercore Ethernet Packet Exchange With ICSSG, Using LwIP Bridge</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM64x MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">10.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLES_ENET_INTERCORE_ICSSG.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Intercore Ethernet Packet Exchange With ICSSG, Using LwIP Bridge </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md1346">Introduction</a></li>
<li class="level1"><a href="#autotoc_md1347">Supported Combinations</a></li>
<li class="level1"><a href="#autotoc_md1348">Configuring Syscfg</a></li>
<li class="level1"><a href="#autotoc_md1349">TCP Client using ncat tool</a></li>
<li class="level1"><a href="#autotoc_md1350">Intercore driver setup</a></li>
<li class="level1"><a href="#autotoc_md1351">Steps to Run the Example</a><ul><li class="level2"><a href="#autotoc_md1352">To Configure Static IP</a></li>
<li class="level2"><a href="#autotoc_md1353">Build the example</a></li>
<li class="level2"><a href="#autotoc_md1354">HW Setup</a><ul><li class="level3"><a href="#autotoc_md1355">AM64X-EVM</a><ul><li class="level4"><a href="#autotoc_md1356">For ICSSG based example</a></li>
</ul>
</li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md1357">Create a network between EVM and host PC</a></li>
<li class="level2"><a href="#autotoc_md1358">Run the example</a></li>
<li class="level2"><a href="#autotoc_md1359">Sample output</a></li>
<li class="level2"><a href="#autotoc_md1360">Steps to execute</a></li>
<li class="level2"><a href="#autotoc_md1361">iPerf Performance</a><ul><li class="level3"><a href="#autotoc_md1362">UDP Throughput</a></li>
<li class="level3"><a href="#autotoc_md1363">TCP Throughput</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md1364">Troubleshooting issues</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md1365">See Also</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_examples_networking_enet_intercore_icssg"></a></p>
<h1><a class="anchor" id="autotoc_md1346"></a>
Introduction</h1>
<dl class="section note"><dt>Note</dt><dd>LwIP features are made available as is from public lwIP project. SDK configuration may only enable and exercise a subset of these features.</dd></dl>
<p>This example shows about how to use shared memory based Intercore driver for data traffic sharing accross coupled with ethernet driver (ENET) and LwIP bridge.</p>
<p>On AM64X, we can do ethernet based communication using ICSSG Hardware peripheral</p><ul>
<li>ICSS<ul>
<li>This is a firmware enabled ethernet switch + port HW</li>
<li>This HW can be used with industrial communication protocols as well</li>
<li>In this example we use ICSS as a standard ethernet port</li>
</ul>
</li>
</ul>
<p>It uses ENET ethernet driver underneath with LwIP TCP/IP networking stack</p>
<p>The example demonstrates the driver feature to exchange ethernet (IEEE 802.1) packets between r5fss0-0 and r5fss0-1 cores, via shared memory and ethernet bridge (LwIP software bridge). CPU core r5fss0-0 fully owns &amp; configures ICSSG1 peripheral resource and the corresponding DMA channels to handle packet reception/transmission directly from/to ICSSG1. It steers the traffic to core r5fss0-1 based on MAC address, using LwIP bridge. Seperate MAC addresses are used to differentiate different CPU core traffic. Both the MAC address are added to ICSSG host port FDB entry so that HW accepts the traffic with those MAC addreess. Seperate TCP/IP (LiWP) stack instances are setup in each core, with independent DHCP client, thus different IP addresses for each core. Furthermore, at application level TCP echo servers are initialized on socket port 8888, in each core to handle the TCP traffic.</p>
<p>Core r5fss0-1 get the packet form ICSSG1 via LwIP bridge running on core r5fss0-0, using shared memory driver.</p>
<p>Few details on the operating sequence of this example is mentioned below:</p>
<ul>
<li>CPU r5fss0-0 initializes ICSSG ethernet driver (LwIP netif 0) and shared memory enet (LwIP netif 1) driver. Setups LwIP bridge with bridgeIF, linked to netif0 and netif1.</li>
<li>CPU r5fss0-1 initializes shared memory enet driver and links to LwIP netif. Prints of r5fss0-1 is directed to CCS console and Prints of r5fss0-0 is directed to UART terminal.</li>
<li>CPU cores r5fss0-0 and r5fss0-1 are referred respectively as main core and remote core in the example. <br  />
</li>
<li>Both r5fss0-0 and r5fss0-1 uses RPMsg to intercommunciated the control messages, in addition to shared memeory interface (which is used to communicate packet data). TCP Server tasks running on each core awaits for connection from external client on port 8888. When connection is established, it waits for a message from the connected client.</li>
<li>In response to external clients message. TCP Server task sends back "Greetings from Texas Instruments!" message back to client and closes the connection.</li>
<li>Supports iPerf TCP performance tests, ping (ICMP) applications across both the cores.</li>
</ul>
<p> <style>div.image img[src="example_enet_intercore_icssg_fig1.drawio.png"]{width:80%}</style> </p><div class="image">
<img src="example_enet_intercore_icssg_fig1.drawio.png" alt=""/>
<div class="caption">
Application Block Diagram</div></div>
<h1><a class="anchor" id="autotoc_md1347"></a>
Supported Combinations</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CPU + OS  </td><td class="markdownTableBodyNone">r5fss0-0_freertos, r5fss0-1_freertos   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Toolchain  </td><td class="markdownTableBodyNone">ti-arm-clang   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Board  </td><td class="markdownTableBodyNone">am64x-evm   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Example folder  </td><td class="markdownTableBodyNone">examples/networking/lwip/enet_intercore_icssg   </td></tr>
</table>
<p>Note: To cnfigura anycore as main core other than r5fss0-0, user needs to change the DMA channel resource allocation to the respective core, so that it can get ICSSG DMA channels for packet tracnser is available for the configured main core. Please refer to <a class="el" href="RESOURCE_ALLOCATION_GUIDE.html">Modifying resource allocation</a> to change the alter the resource allocation.</p>
<h1><a class="anchor" id="autotoc_md1348"></a>
Configuring Syscfg</h1>
<ul>
<li>Following Syscfg option allows flexibility to configure memory foot print based on required use case like: Gigabit Ethernet Support Enable, premption support, McM Support and QoS level required.</li>
<li>Supported Options with default configuration</li>
</ul>
<table class="doxtable">
<tr>
<th>Feature </th><th>Description </th><th><p class="starttd">Remarks/Default Setting </p>
<p class="endtd"></p>
</th></tr>
<tr>
<td>Pkt Pool Enable Flag nable Flag </td><td>Flag to enable packet allocation from enet utils library. It should be disabled to avoid utils memory wastage, in case application allots packet via other mechanism. (Ex- Lwip pools) </td><td><p class="starttd">Default is true. It is disabled for lwip based examples. If enabled size of pkt pool size depends on Number of Tx Packet and Number of Rx Packet. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Number of Tx Packet </td><td>No of Tx packets required for DMA channel </td><td><p class="starttd">Default is 16. It contributes to the size of Pkt Mem Pool, DMA ring buffer and accessories. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Number of Rx Packet </td><td>No of Rx packets required for DMA channel </td><td><p class="starttd">Default is 32. It contributes to the size of Pkt Mem Pool, DMA ring buffer and accessories size.</p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>QoS Level </td><td>No of QoS level required </td><td><p class="starttd">Can be in between 1-8. Higher QoS level will be serviced by adding more number of buffers. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Premption Enable </td><td>Flag to enable premption </td><td><p class="starttd">Default is false. If enabled will add premption buffer to service the feature. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Gigabit Support </td><td>Decides buffer pool allocation based on interface speed selected </td><td><p class="starttd">Default is true. Enabling this option will increase buffer requirement as more buffering required at gigabit speed. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Netif instance </td><td>TI Networking / Enet (ICSSG) / LWIP Interface config </td><td>No of netifs allocated by the example </td><td>Only one netif should be set to default when more than one netif is allocated.  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md1349"></a>
TCP Client using ncat tool</h1>
<p>Ncat is a general-purpose command-line tool for reading, writing, redirecting, and encrypting data across a network. It aims to be your network Swiss Army knife, handling a wide variety of security testing and administration tasks. Ncat is suitable for interactive use or as a network-connected back end for other tools.</p><ul>
<li>Ncat is started as server to which EVM connects.</li>
<li>Version used for this example Version 7+ ( <a href="https://nmap.org/ncat">https://nmap.org/ncat</a> )</li>
</ul>
<h1><a class="anchor" id="autotoc_md1350"></a>
Intercore driver setup</h1>
<ol type="1">
<li>Intercore driver is a shared memory based data routing layer used to send data traffic across cores.</li>
<li>This needs two unique channels open between given pair of cores.</li>
<li>This needs shared memory space, which is placed in a commonly accessible region.</li>
<li>The region and the channel depth can be adjusted through application code.</li>
<li>This uses custom pBufs which helps in decreasing the memory footprint on other dependent libraries.</li>
<li>This example can be modified to work in tandem with linux. Refer to TI academy (or TI E2E forums) for more details.</li>
</ol>
<h1><a class="anchor" id="autotoc_md1351"></a>
Steps to Run the Example</h1>
<h2><a class="anchor" id="autotoc_md1352"></a>
To Configure Static IP</h2>
<p>Please refer to <a class="el" href="NETWORKING_LWIP_STATIC_IP.html">Ethernet LwIP TCP/IP Static IP</a>.</p>
<h2><a class="anchor" id="autotoc_md1353"></a>
Build the example</h2>
<ul>
<li>When using CCS projects to build, import the CCS project for the required combination and build it using the CCS project menu (see <a class="el" href="CCS_PROJECTS_PAGE.html">Using SDK with CCS Projects</a>).</li>
<li>When using makefiles to build, note the required combination and build using make command (see <a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
</ul>
<h2><a class="anchor" id="autotoc_md1354"></a>
HW Setup</h2>
<dl class="section note"><dt>Note</dt><dd>Make sure you have setup the EVM with cable connections as shown here, <a class="el" href="EVM_SETUP_PAGE.html">EVM Setup</a>. In addition do below steps.</dd></dl>
<h3><a class="anchor" id="autotoc_md1355"></a>
AM64X-EVM</h3>
<h4><a class="anchor" id="autotoc_md1356"></a>
For ICSSG based example</h4>
<ul>
<li>Connect a ethernet cable to the EVM from host PC as shown below</li>
</ul>
<p> <style>div.image img[src="am64x_evm_lwip_example_00.png"]{width:30%}</style> </p><div class="image">
<img src="am64x_evm_lwip_example_00.png" alt=""/>
<div class="caption">
Ethernet cable for CPSW based ethernet</div></div>
<h2><a class="anchor" id="autotoc_md1357"></a>
Create a network between EVM and host PC</h2>
<ul>
<li>The EVM will get an IP address using DHCP, so make sure to connect the other end of the cable to a network which has a DHCP server running.</li>
<li>To get started one can create a simple local network between the EVM and the host PC by using a home broadband/wifi router as shown below. Most such routers run a DHCP server</li>
</ul>
<p> <style>div.image img[src="lwip_example_01.png"]{width:30%}</style> </p><div class="image">
<img src="lwip_example_01.png" alt=""/>
<div class="caption">
Local network between PC and EVM</div></div>
<ul>
<li>To check the router connection with host PC, recommend to disconnect all other networking conenctions on the PC, sometimes you may need to disable firewall SW, and make sure the routeuter is able to assign a IP address to your host PC</li>
<li>After we run the example on the EVM (next step), the EVM will similarly be assigned a IP address, and then host can communicate with the EVM using the assigned IP address.</li>
<li>To enable static IP, set the static IP in the ipAddr variable in the App_setupNetif() before passing it as arguement to initiate the netif, and stop the dhcp from starting in the App_allocateIPAddress() function.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1358"></a>
Run the example</h2>
<dl class="section attention"><dt>Attention</dt><dd>If you need to reload and run again, a CPU power-cycle is MUST</dd></dl>
<ul>
<li>Launch a CCS debug session and run the example executable, see <a class="el" href="CCS_LAUNCH_PAGE.html">CCS Launch, Load and Run</a></li>
<li>You will see logs in the UART terminal as shown in the next section.</li>
<li>Note the IP address seen in the log, this is what we will use to communicate with the EVM.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1359"></a>
Sample output</h2>
<div class="fragment"></div><!-- fragment --><h2><a class="anchor" id="autotoc_md1360"></a>
Steps to execute</h2>
<ol type="1">
<li>Run example on EVM</li>
<li>Try to reach the EVM using ping as shown below, using a command shell on the host PC <div class="fragment"><div class="line">$ping 192.168.1.10</div>
</div><!-- fragment --> "192.168.1.10" should be replaced with IP of EVM.</li>
<li><p class="startli">Start TCP client using 'ncat' cmds as shown below. Below steps have been tried with a Linux Ubuntu 18.04 host PC running bash shell</p>
<p class="startli">Install 'ncat' if not installed by doing below </p><div class="fragment"><div class="line">$sudo apt install ncat</div>
</div><!-- fragment --><p class="startli">Invoke 'ncat' to connect to EVM IP </p><div class="fragment"><div class="line">$ncat 192.168.1.10 8888</div>
<div class="line">$</div>
</div><!-- fragment --><p> "192.168.1.10" should be replaced with EVM IP.</p>
</li>
<li>Send any msg in ncat terminal and wait for reply from EVM.</li>
<li>Close the connection using Ctrl + C.</li>
</ol>
<h2><a class="anchor" id="autotoc_md1361"></a>
iPerf Performance</h2>
<h3><a class="anchor" id="autotoc_md1362"></a>
UDP Throughput</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Direction  </th><th class="markdownTableHeadNone">Main core  </th><th class="markdownTableHeadNone">Remote Core   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">From Networt; To core  </td><td class="markdownTableBodyNone">200 Mbps @ 100% CPU load  </td><td class="markdownTableBodyNone">150 Mbps @ 85% CPU load   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">From Core; To Network  </td><td class="markdownTableBodyNone">200 Mbps @ 100% CPU load  </td><td class="markdownTableBodyNone">160 Mbps @ 75% CPU load   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md1363"></a>
TCP Throughput</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Direction  </th><th class="markdownTableHeadNone">Main core  </th><th class="markdownTableHeadNone">Remote Core   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">From Networt; To core  </td><td class="markdownTableBodyNone">93 Mbps @ 60% CPU load  </td><td class="markdownTableBodyNone">46.6 Mbps @ 25% CPU load   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">From Core; To Network  </td><td class="markdownTableBodyNone">93 Mbps @ 80% CPU load  </td><td class="markdownTableBodyNone">46.6 Mbps @ 20% CPU load   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md1364"></a>
Troubleshooting issues</h2>
<ul>
<li>If you see MAC address as <code>00:00:00:00:00:00</code>, likely you are using a very early Si sample which does not have MAC address "fused" in, in this case do below steps<ul>
<li>Use manual MAC address populate option from sysconfig GUI</li>
</ul>
</li>
<li>If you see a valid, non-zero MAC address and continuosly see "Waiting for network UP..." prints in UART terminal<ul>
<li>Make sure you see <code>Enet IF UP Event.</code> message, if not check the ethernet cable</li>
<li>Check the local network and check if the DHCP server is indeed running as expected</li>
<li>When using a home broadband/wifi router, its possible to check the clients connected to the DHCP server via a web browser. Check your router user manual for more details.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md1365"></a>
See Also</h1>
<p><a class="el" href="NETWORKING.html">Ethernet And Networking</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
